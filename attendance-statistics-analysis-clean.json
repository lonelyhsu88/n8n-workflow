{
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours"
            }
          ]
        }
      },
      "id": "804afbe4-cdf1-4fb3-9c7e-c76d1afa1fda",
      "name": "æ¯å°æ™‚åŸ·è¡Œ1",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -1872,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// å®Œæ•´çš„å‡ºç¼ºå‹¤è§£æç¨‹å¼ç¢¼ - ä¿®æ­£ç‰ˆ\n// æ”¯æ´æ—¥æœŸèˆ‡å‡åˆ¥ä¸€å°ä¸€å°æ‡‰ã€æ’é™¤é€±æœ«\n// ç‰¹åˆ¥è™•ç† \"9/8 bread remote\" æ ¼å¼\n// ========================================\n\nconst messages = $input.all();\nconst attendanceData = [];\nconst taipeiTimeZone = 'Asia/Taipei';\nconst today = new Date();\nconst todayTaipei = new Date(toda06MH0UMZGW\": \"QA-Millie\",\n  \"U0816827JR3\": \"Design-Sendai\",\n  \"U07A8G83R2S\": \"Design-Jill Su\",\n  \"U05CW44GTCP\": \"RD-K7\",\n  \"U080U19HFV5\": \"DevOps-Ollie\",\n  \"U08AZSVBHFZ\": \"PM-Rjin\",\n  \"U08HJ1F8YAK\": \"PM-Mark\",\n  \"U07FJ5E4WF6\": \"RD-Dean\",\n  \"U02R8STEK8D\": \"RD-Ziv\",\n  \"U08C9QZUVSL\": \"Finance-Vicky\",\n  \"U05F85X2S67\": \"RD-Hannah\",\n  \"U08BLQ5V2CB\": \"QA-Kevin Chang\",\n  \"U08KL8ASPEU\": \"RD-Jeff Lee\",\n  \"U07KG73JCDQ\": \"PM-Luann\",\n  \"U07FFHDSRQT\": \"RD-Owen\",\n  \"U07QMF4269H\": \"QA-Shelby\",\n  \"U80KYE8LU\":   \"IT Director-BroHand\",\n  \"U08C2PS0D5M\": \"Design-Vera\",\n  \"U07KG7E59EW\": \"PM-Corrine\",\n  \"U07JU0N3PJS\": \"RD-Joe\",\n  \"U08BJ6Q6XM3\": \"RD-Kathy\",\n  \"U078F6EJWMA\": \"Finance-Victorya\",\n  \"UL329CFKQ\":   \"RD-Ohm\",\n  \"U07F06X4C1Z\": \"Design-Kenny\",\n  \"U07F9203EP8\": \"DevOps-Lonely\",\n  \"U07SQFQNC1H\": \"PM-Yihsiu\",\n  \"U08MNGPS63A\": \"RD-Adam Lee\",\n  \"U0591NH34G6\": \"RD-Hector\",\n  \"U04JYL4TYQ7\": \"RD-Luke Dai\",\n  \"U05F2KCDW14\": \"Finance-Dabby\",\n  \"U05F2KKNR6J\": \"Finance-Julia\",\n  \"U09D0VBDSJG\": \"food.kuo\",\n  \"U085KPCTYPM\": \"RD-Andie\",\n  \"U07A8J3L71C\": \"OP-Henry\",\n  \"U06PYV3G066\": \"RD-Ennis\",\n  \"U07FJ5E6XAQ\": \"RD-Henry Ye\",\n  \"U07QJPJ6N4V\": \"RD-Kevin Hsu\",\n  \"U07UH4MU7BN\": \"QA-Phoebus\",\n  \"U06NR2K81T7\": \"Design-Kappa\",\n  \"U06QMNU640Y\": \"PM-Iris\",\n  \"U078F4F0BKN\": \"QA-Emma\",\n  \"U07FFHE0B9R\": \"RD-Adam Lu\",\n  \"U07FJ5E7SJ0\": \"OP-James\",\n  \"U07F2TQ9TRS\": \"RD-Rick Hsieh\",\n  \"U03L2C72FKR\": \"AM-Joy\",\n  \"U05F1LC6JQN\": \"RD-Jean\",\n  \"U04P80EM4JD\": \"RD-Conray\",\n  \"U08TVT3QPGD\": \"RD-Winston\",\n  \"U082RGRGA5D\": \"Design-Eve\",\n  \"U07F9202N3Y\": \"RD-Bread\",\n  \"U08H2HD4LF7\": \"DevOps-ZhiXuan\",\n  \"U07F14AQ5ST\": \"QA-Lisa\",\n  \"U07F14AS00P\": \"Design-Didi\",\n  \"U063G3YC64X\": \"RD-Ting\",\n  \"U05FBNC3ES0\": \"DS88-AE-Nick\",\n  \"USLACKBOT\":   \"Slackbot\",\n  \"U05F2M9254N\": \"PDM-Luke Tsai\",\n  \"U08B820DB0E\": \"PM-Sitara\",\n  \"U095BDAJ47K\": \"RD-Errol\",\n  \"U07FFLJJ2H0\": \"RD-David Kuo\",\n  \"UB3B2R05P\":   \"HEAD of IT-Jack\",\n  \"U07FJ5E3NSG\": \"RD-Phoebe\",\n  \"U05EYM9KBST\": \"Design-Fred\",\n  \"U05TW44AT5Z\": \"RD-Henry Huang\",\n  \"U01T34WB28Y\": \"OP-Louis\",\n  \"U08BD80E36K\": \"RD-Greg\",\n  \"U065AM8MKRT\": \"RD-York\",\n  \"U07KDB2SZM3\": \"PM-Jeff Su\",\n  \"U071J5VGEBX\": \"Audit-Aaron\",\n  \"U048K0US9NW\": \"OP-Allen\",\n  \"U08SQ7B1HH9\": \"Audit-Nancy\",\n  \"U05G9MM0SRE\": \"Audit-Mike Chen\",\n  \"U05FBSX6GBE\": \"Audit-Cindy\",\n  \"U07BCQELYSX\": \"Finance-Judy\",\n  \"U06TKLPF8NM\": \"OP-Hao\",\n  \"U06N2ADU797\": \"QA-Jill\",\n  \"U05ETQUBJUF\": \"GM-Mish\",\n  \"U8154CHAN\":   \"JVD-Ping\",\n  \"U050QQTK8TB\": \"JVD-AM-Gabriel\",\n  \"U06JWRZ8LDR\": \"BA-Yennie\",\n  \"U08FTHXDS74\": \"PM-Monta\",\n  \"U06MS8LD220\": \"QA-Luke Chang\",\n  \"U060TCJ7VV5\": \"RD-Kent\",\n  \"U0733C2EJ9G\": \"RD-Wilson\",\n  \"U05F99NDMEW\": \"RD-Hank\",\n  \"U037EJTEWUR\": \"RD-Edgar\",\n  \"U01M9LP05BN\": \"RD-Kevin Zhao\",\n  \"U0850UQB422\": \"Design-Ero\",\n  \"U05MPQ6T65A\": \"RD-Phil\",\n  \"U05FMTYPWHX\": \"QA-Han\",\n  \"U0818HD693M\": \"QA-Lily\",\n  \"U04JCNZPVSA\": \"RD-Ricky\",\n  \"U06U0TXTTP1\": \"RD-Joey\",\n  \"U08BSUQGM97\": \"RD-Ian\",\n  \"U08362N5X2P\": \"RD-Kellen\",\n  \"U08FW3QRH2Q\": \"Audit-King Chen\",\n  \"U05F95VUGHZ\": \"Finance-Sam\",\n  \"U0758F82ZN1\": \"PM-William\",\n  \"U07F14AR29M\": \"RD-Ken Yeh\",\n  \"U066U9DKBGS\": \"RD-Alex\",\n  \"U06SSFVRAQ7\": \"RD-K11\",\n  \"U07KTJFBAN6\": \"PM-Wells\",\n  \"U06ETLL1X7X\": \"AE-Judy\",\n  \"U05F97ZMLEP\": \"DS88-AM-Victor\",\n  \"U025C3UBDP1\": \"RD-Kevin Wang\",\n  \"U05L0T4K9KK\": \"RD-Janet\",\n  \"U05FC6WUUDA\": \"OP-David Ling\",\n  \"U04744BB5GS\": \"OP-Kevin Hu\",\n  \"U0846N9SEGJ\": \"Design-Ora\",\n  \"U05F2M2R9U6\": \"HR-Freda\",\n  \"U8ECWKV7V\":   \"PE-Spencer\",\n  \"U05KKAEDGMT\": \"RD-Rick Lee\",\n  \"U05GM2TPF5Y\": \"JVD-ç‰¹åŠ©-Maggie\",\n  \"U07FFHDTPFD\": \"HR-Momo\",\n  \"U07GG32LGRY\": \"RD-VincentLin\",\n  \"U05KNSF3USF\": \"PM-Bruce\",\n  \"U06KEK1RDPV\": \"PM-Phoebe\",\n  \"U07FJ5E5XL4\": \"PM-Harry\",\n  \"U07FCPQ3BEZ\": \"Design-Shu\",\n  \"U07F65P3TFD\": \"QA-Thomas\",\n  \"U07FFLJGYAW\": \"Design-Tommy\",\n  \"U0726D4HD3K\": \"Audit-Hook\",\n  \"U07G4EJQ0QG\": \"RD-Aki\",\n  \"U05FG0ZD268\": \"HR-Yura\",\n  \"U02RSBFSND8\": \"RD-Vincent\",\n  \"U06N2EL13SM\": \"RD-Tim Chao\",\n  \"U07F16QT23H\": \"AE-Paul\",\n  \"U07AF3WDBD1\": \"PM-Angelina\",\n  \"U05GZAHLCHX\": \"Gemini-AM-Aria\",\n  \"U07F052R9U3\": \"RD-Iris Lu\",\n  \"U03GL698Y5T\": \"JVD-AE-Jeff\",\n  \"U05J9LQNA2Z\": \"Head of Pymt-Ena\",\n  \"U05KJJ37B9S\": \"Finance-AWA\",\n  \"U0756PHUDPD\": \"PM-Mai\",\n  \"U04E2R04TJ6\": \"HR-Momo\",\n  \"U071M5X0Q4S\": \"HR-Chiachen\",\n  \"U06KKM456QY\": \"AE-Jordan\",\n  \"U07651RGRL5\": \"Android-Jason\",\n  \"U0760J0TR4N\": \"Admin-Ailee\",\n  \"U03LV05L5EV\": \"Head of BD-Rory\",\n  \"U05L0V06ABT\": \"PM-Harry\",\n  \"U05JNFHJW12\": \"Pymt-Vivian\",\n  \"U05UK8WU1CY\": \"Gemini-MKAM-Allan\",\n  \"U06MH1LAD38\": \"DS88-AE-Jasper\",\n  \"U05UH3KHU0N\": \"AE-Sadie\",\n  \"U01H4KULB0F\": \"PM-Andrew\",\n  \"U05F1KW56Q6\": \"DevOps-Randy\",\n  \"U05QTMD290A\": \"AE-Una\",\n  \"U066THLFWLE\": \"Admin-Ariel\",\n  \"U06D6BXH4F4\": \"HR-Julia\",\n  \"U059PNW4WNQ\": \"RD-Edmond\",\n  \"U05F99KF5GS\": \"HR-Erin\",\n  \"U063MD7SDK7\": \"RD-Reid\",\n  \"U05DUU5GMLZ\": \"OP-Leo Chen\",\n  \"U03V8GXMQLX\": \"JVD-CS-Henry\",\n  \"U05H941SLCX\": \"Zapier\",\n  \"U05FGJTNASG\": \"JVD-ç‰¹åŠ©-Stephanie\",\n  \"U06R3B4EPKL\": \"Audit-Hook\",\n  \"U0617S868KD\": \"GameCS-Steven\",\n  \"U060Z6X4TMX\": \"GameCS-Marz\",\n  \"U068EJYAP0S\": \"GameCS-Shiro\",\n  \"U060GURHSHW\": \"GameCS-Karry\",\n  \"U06232M8PSS\": \"GameCS-Kevin\",\n  \"U062NATPJRF\": \"GameCS-Annber\",\n  \"U06CW2DUWDS\": \"GameCS-Orton\",\n  \"U06MPFZ07DG\": \"GameCS-Juice\",\n  \"U06TS6PQVFB\": \"GameCS-Justin\",\n  \"U06S2DJCJF7\": \"GameCS-Una\",\n  \"U06SJ0P9ZBK\": \"GameCS-Jasy\",\n  \"U06S7RLNY5S\": \"GameCS-Wolf\",\n  \"U05MU2NCC06\": \"FBPay-Clay\",\n  \"U09A5CXPHT3\": \"QA-Carol\"\n};\n\n// åç¨±åˆ¥åå°ç…§è¡¨ï¼ˆè™•ç† bread -> RD-Bread é€™ç¨®æƒ…æ³ï¼‰\nconst nameAliases = {\n  \"bread\": \"RD-Bread\",\n  \"mark\": \"PM-Mark\",\n  \"mike\": \"Math-Mike Tsai\",\n  // å¯ä»¥æ ¹æ“šéœ€è¦æ·»åŠ æ›´å¤šåˆ¥å\n};\n\n// å®šç¾©ç‹€æ…‹é—œéµå­—\nconst statusKeywords = {\n  'remote': 'é ç«¯å·¥ä½œ',\n  'wfh': 'åœ¨å®¶å·¥ä½œ',\n  'work from home': 'åœ¨å®¶å·¥ä½œ',\n  'è«‹å‡': 'è«‹å‡',\n  'ç—…å‡': 'ç—…å‡',\n  'äº‹å‡': 'äº‹å‡',\n  'ç‰¹ä¼‘': 'ç‰¹ä¼‘',\n  'å¹´å‡': 'å¹´å‡',\n  'ç”Ÿæ—¥å‡': 'ç”Ÿæ—¥å‡',\n  'birthday': 'ç”Ÿæ—¥å‡',\n  'bdå‡': 'ç”Ÿæ—¥å‡',\n  'bd': 'ç”Ÿæ—¥å‡',\n  'å‡ºå·®': 'å‡ºå·®',\n  'å…¬å‡º': 'å…¬å‡º',\n  'åŠå¤©': 'è«‹å‡åŠå¤©',\n  'ä¸Šåˆè«‹å‡': 'ä¸Šåˆè«‹å‡',\n  'ä¸‹åˆè«‹å‡': 'ä¸‹åˆè«‹å‡',\n  'æ—©é€€': 'æ—©é€€',\n  'é²åˆ°': 'é²åˆ°',\n  'å¤–å‡º': 'å¤–å‡º',\n  'å¥æª¢': 'å¥æª¢',\n  'å©šå‡': 'å©šå‡',\n  'å–ªå‡': 'å–ªå‡',\n  'ç”¢å‡': 'ç”¢å‡',\n  'é™ªç”¢å‡': 'é™ªç”¢å‡',\n  'è‚²å¬°å‡': 'è‚²å¬°å‡',\n  'å®¶åº­ç…§é¡§å‡': 'å®¶åº­ç…§é¡§å‡',\n  'å…¬å‡': 'å…¬å‡',\n  'è£œä¼‘': 'è£œä¼‘',\n  'èª¿ä¼‘': 'èª¿ä¼‘',\n  'ç”Ÿç†å‡': 'ç”Ÿç†å‡'\n};\n\n// è‡ªå‹•å»ºç«‹çš„ä½¿ç”¨è€…å°ç…§è¡¨\nconst autoUserMapping = {};\nconst unknownUsers = new Set();\n\n// æƒææ‰€æœ‰è¨Šæ¯ï¼Œå»ºç«‹ä½¿ç”¨è€…å°ç…§è¡¨\nfor (const item of messages) {\n  const message = item.json;\n  \n  if (message.user && message.user_profile) {\n    const userId = message.user;\n    const profile = message.user_profile;\n    const userName = profile.real_name || profile.display_name || profile.name || userId;\n    \n    if (userName && userName !== userId) {\n      autoUserMapping[userId] = userName;\n    }\n  }\n}\n\n// åˆä½µæ‰‹å‹•å’Œè‡ªå‹•çš„å°ç…§è¡¨\nconst finalUserMapping = { ...autoUserMapping, ...userMapping };\n\n// å–å¾—ä½¿ç”¨è€…é¡¯ç¤ºåç¨±\nfunction getUserDisplayName(userId) {\n  if (userMapping[userId]) {\n    return userMapping[userId];\n  }\n  if (autoUserMapping[userId]) {\n    return autoUserMapping[userId];\n  }\n  return userId;\n}\n\n// æ›¿æ›è¨Šæ¯ä¸­çš„ä½¿ç”¨è€… ID ç‚ºå¯¦éš›å§“å\nfunction replaceUserIdsWithNames(text) {\n  let replacedText = text;\n  // è™•ç† <@UserID> æ ¼å¼\n  const userIdPattern = /<@([A-Z0-9]+)>/g;\n  replacedText = replacedText.replace(userIdPattern, (match, userId) => {\n    const userName = getUserDisplayName(userId);\n    return `@${userName}`;\n  });\n  // è™•ç† <@PM-Mark> æ ¼å¼ï¼ˆå·²ç¶“æ˜¯åç¨±ï¼‰\n  const namePattern = /<@([^>]+)>/g;\n  replacedText = replacedText.replace(namePattern, (match, name) => {\n    // å¦‚æœä¸æ˜¯ User ID æ ¼å¼ï¼Œç›´æ¥è¿”å›åç¨±\n    if (!/^U[A-Z0-9]+$/.test(name)) {\n      return `@${name}`;\n    }\n    return match;\n  });\n  return replacedText;\n}\n\n// è§£æè¨Šæ¯ç‹€æ…‹\nfunction parseMessageStatus(messageText) {\n  // ç§»é™¤æ‹¬è™Ÿå…§å®¹å¦‚ï¼ˆä¸»ç®¡å·²åŒæ„ï¼‰\n  let cleanText = messageText.replace(/[ï¼ˆ(][^ï¼‰)]*[ï¼‰)]/g, '').trim();\n  const textLower = cleanText.toLowerCase();\n  \n  // æª¢æŸ¥é—œéµå­— - ä½¿ç”¨å–®å­—é‚Šç•ŒåŒ¹é…é˜²æ­¢èª¤åˆ¤\n  for (const [keyword, statusName] of Object.entries(statusKeywords)) {\n    // å°æ–¼çŸ­é—œéµå­—ï¼ˆå¦‚ bdã€wfhï¼‰ï¼Œä½¿ç”¨å–®å­—é‚Šç•ŒåŒ¹é…\n    if (keyword.length <= 3) {\n      const escapedKeyword = keyword.replace(/[.*+?^${}()|[\\\\\\\\]\\\\\\\\]/g, '\\\\\\\\\\\\\\\\$&');\n      const regexPattern = '\\\\\\\\\\\\\\\\b' + escapedKeyword + '\\\\\\\\\\\\\\\\b';\n      const regex = new RegExp(regexPattern, 'i');\n      if (regex.test(cleanText)) {\n        return statusName;\n      }\n    } else {\n      // é•·é—œéµå­—ä½¿ç”¨åŸæœ¬çš„åŒ…å«åŒ¹é…\n      if (textLower.includes(keyword)) {\n        return statusName;\n      }\n    }\n  }\n  \n  return 'æ­£å¸¸ä¸Šç­';\n}\n\n// å¾è¨Šæ¯æ–‡å­—ä¸­æå–å¯¦éš›è«‹å‡çš„ä½¿ç”¨è€…ï¼ˆä¿®æ­£ç‰ˆ - æ”¯æ´ \"9/8 bread remote\" æ ¼å¼ï¼‰\nfunction extractActualUser(messageText) {\n  // === æ–°å¢ï¼šæª¢æŸ¥ç‰¹æ®Šæ ¼å¼ \"æ—¥æœŸ åç¨± ç‹€æ…‹\" ===\n  // ä¾‹å¦‚: \"9/8 bread remote\", \"9/5 mark è«‹å‡\"\n  const specialPattern = /^\\d{1,2}\\/\\d{1,2}\\s+([a-zA-Z]+)\\s+/i;\n  const specialMatch = messageText.match(specialPattern);\n  \n  if (specialMatch) {\n    const nameFound = specialMatch[1].toLowerCase();\n    \n    // æª¢æŸ¥æ˜¯å¦ç‚ºå·²çŸ¥çš„åˆ¥å\n    if (nameAliases[nameFound]) {\n      return { userId: null, userName: nameAliases[nameFound] };\n    }\n    \n    // å˜—è©¦åœ¨ userMapping ä¸­å°‹æ‰¾åŒ¹é…çš„åç¨±\n    for (const [userId, fullName] of Object.entries(finalUserMapping)) {\n      if (fullName.toLowerCase().includes(nameFound)) {\n        return { userId: userId, userName: fullName };\n      }\n    }\n    \n    // å¦‚æœéƒ½æ‰¾ä¸åˆ°ï¼Œå°‡ç¬¬ä¸€å€‹å­—æ¯å¤§å¯«å¾Œè¿”å›\n    const capitalizedName = nameFound.charAt(0).toUpperCase() + nameFound.slice(1);\n    return { userId: null, userName: capitalizedName };\n  }\n  \n  // === åŸæœ‰çš„æ¨¡å¼è™•ç† ===\n  // æ¨¡å¼1: <@UserID> æ ¼å¼ï¼ˆUser IDï¼‰\n  const pattern1 = /<@(U[A-Z0-9]+)>/;\n  const match1 = messageText.match(pattern1);\n  \n  if (match1) {\n    const userId = match1[1];\n    return { userId: userId, userName: getUserDisplayName(userId) };\n  }\n  \n  // æ¨¡å¼2: <@ä½¿ç”¨è€…åç¨±> æ ¼å¼ï¼ˆå¦‚ <@PM-Mark>ï¼‰\n  const pattern2 = /<@([^>]+)>/;\n  const match2 = messageText.match(pattern2);\n  \n  if (match2) {\n    const name = match2[1];\n    // å¦‚æœä¸æ˜¯ User ID æ ¼å¼ï¼Œå‰‡ç•¶ä½œä½¿ç”¨è€…åç¨±\n    if (!/^U[A-Z0-9]+$/.test(name)) {\n      return { userId: null, userName: name };\n    }\n  }\n  \n  // æ¨¡å¼3: @ä½¿ç”¨è€…åç¨± æ ¼å¼ï¼ˆä¸å¸¶å°–æ‹¬è™Ÿï¼‰\n  const pattern3 = /@([^\\s>]+)/;\n  const match3 = messageText.match(pattern3);\n  \n  if (match3) {\n    const name = match3[1];\n    return { userId: null, userName: name };\n  }\n  \n  return null;\n}\n\n// è§£ææ—¥æœŸèˆ‡å‡åˆ¥ä¸€å°ä¸€å°æ‡‰çš„æ ¼å¼\n// ä¾‹å¦‚: \"9/1ã€9/2 @Math-Mike Tsai ç”Ÿæ—¥å‡ï¼†ç‰¹ä¼‘\" â†’ 9/1ç”Ÿæ—¥å‡, 9/2ç‰¹ä¼‘\nfunction parseDateLeaveMapping(messageText, messageTimestamp) {\n  const currentYear = new Date().getFullYear();\n  const results = [];\n  \n  // å…ˆæª¢æŸ¥æ˜¯å¦ç‚ºæ—¥æœŸç¯„åœæ ¼å¼ï¼ˆä¸æ‡‰è©²ç”¨é€™å€‹å‡½æ•¸è™•ç†ï¼‰\n  if (messageText.match(/\\d{1,2}\\/\\d{1,2}\\s*[~ï½\\-]\\s*\\d{1,2}\\/\\d{1,2}/)) {\n    return []; // æ—¥æœŸç¯„åœæ‡‰è©²ç”± extractLeaveDates è™•ç†\n  }\n  \n  // æª¢æŸ¥æ˜¯å¦æœ‰é “è™Ÿåˆ†éš”çš„å¤šå€‹æ—¥æœŸ\n  if (!messageText.includes('ã€')) {\n    return []; // æ²’æœ‰é “è™Ÿï¼Œä¸æ˜¯ä¸€å°ä¸€å°æ‡‰æ ¼å¼\n  }\n  \n  // æå–ä½¿ç”¨è€…\n  const userInfo = extractActualUser(messageText);\n  const userName = userInfo ? userInfo.userName : 'Unknown';\n  \n  // ç§»é™¤ä½¿ç”¨è€…æ¨™è¨˜ï¼Œæº–å‚™è§£æ\n  let cleanText = messageText.replace(/<@[^>]+>/g, '').replace(/@[^\\s]+/, '').trim();\n  \n  // æ¨¡å¼: \"9/1ã€9/2 ç”Ÿæ—¥å‡ï¼†ç‰¹ä¼‘\"ï¼ˆå¿…é ˆæœ‰é “è™Ÿå’Œå¤šç¨®å‡åˆ¥ï¼‰\n  const pattern = /^([\\d\\/\\sã€ï¼Œ,]+)\\s+(.+)$/;\n  const match = cleanText.match(pattern);\n  \n  if (match) {\n    const datesPart = match[1];\n    const leavesPart = match[2];\n    \n    // æª¢æŸ¥æ˜¯å¦æœ‰å¤šç¨®å‡åˆ¥ï¼ˆç”¨ & æˆ– ï¼† åˆ†éš”ï¼‰\n    const hasMultipleLeaves = leavesPart.includes('&') || leavesPart.includes('ï¼†');\n    \n    if (!hasMultipleLeaves) {\n      return []; // åªæœ‰ä¸€ç¨®å‡åˆ¥ï¼Œä¸éœ€è¦ä¸€å°ä¸€å°æ‡‰\n    }\n    \n    // è§£ææ—¥æœŸåˆ—è¡¨\n    const dates = [];\n    const datePattern = /\\d{1,2}\\/\\d{1,2}/g;\n    const dateMatches = datesPart.match(datePattern);\n    \n    if (dateMatches) {\n      for (const dateStr of dateMatches) {\n        const [month, day] = dateStr.split('/').map(Number);\n        if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {\n          const leaveDate = new Date(currentYear, month - 1, day);\n          \n          // æª¢æŸ¥æ˜¯å¦ç‚ºé€±æœ«\n          const dayOfWeek = leaveDate.getDay();\n          if (dayOfWeek === 0 || dayOfWeek === 6) {\n            continue; // è·³éé€±æœ«\n          }\n          \n          // èª¿æ•´å¹´ä»½ - æ”¹é€²é‚è¼¯\n          const messageDate = new Date(messageTimestamp);\n          const daysDiff = (messageDate - leaveDate) / (1000 * 60 * 60 * 24);\n          \n          if (daysDiff > 0 && daysDiff < 60 && messageDate.getMonth() > month - 1) {\n            leaveDate.setFullYear(currentYear - 1);\n          } else if (daysDiff > 180) {\n            leaveDate.setFullYear(currentYear + 1);\n          } else if (daysDiff < -180) {\n            leaveDate.setFullYear(currentYear - 1);\n          }\n          \n          dates.push({\n            date: leaveDate,\n            dateStr: leaveDate.toLocaleDateString('zh-TW', {\n              timeZone: taipeiTimeZone,\n              year: 'numeric',\n              month: '2-digit',\n              day: '2-digit'\n            })\n          });\n        }\n      }\n    }\n    \n    // è§£æå‡åˆ¥åˆ—è¡¨ï¼ˆç§»é™¤æ‹¬è™Ÿå…§å®¹ï¼‰\n    let cleanLeaves = leavesPart.replace(/[ï¼ˆ(][^ï¼‰)]*[ï¼‰)]/g, '').trim();\n    const leaves = [];\n    const separators = ['&', 'ï¼†'];\n    let leaveParts = [cleanLeaves];\n    \n    for (const separator of separators) {\n      if (cleanLeaves.includes(separator)) {\n        leaveParts = cleanLeaves.split(separator).map(p => p.trim()).filter(p => p);\n        break;\n      }\n    }\n    \n    // è­˜åˆ¥æ¯å€‹å‡åˆ¥\n    for (const part of leaveParts) {\n      const partLower = part.toLowerCase();\n      let matchedStatus = null;\n      \n      for (const [keyword, statusName] of Object.entries(statusKeywords)) {\n        if (partLower.includes(keyword.toLowerCase())) {\n          matchedStatus = statusName;\n          break;\n        }\n      }\n      \n      leaves.push(matchedStatus || part);\n    }\n    \n    // å»ºç«‹æ—¥æœŸèˆ‡å‡åˆ¥çš„å°æ‡‰é—œä¿‚\n    if (dates.length === leaves.length && dates.length > 1) {\n      // å®Œç¾å°æ‡‰ï¼šæ¯å€‹æ—¥æœŸå°æ‡‰ä¸€å€‹å‡åˆ¥\n      for (let i = 0; i < dates.length; i++) {\n        results.push({\n          date: dates[i].dateStr,\n          status: leaves[i],\n          userName: userName\n        });\n      }\n      return results;\n    }\n  }\n  \n  return [];\n}\n\n// å¾è¨Šæ¯è©³æƒ…ä¸­è§£æå¯¦éš›è«‹å‡æ—¥æœŸï¼ˆæ”¯æ´æ—¥æœŸç¯„åœï¼Œæ’é™¤é€±æœ«ï¼‰\nfunction extractLeaveDates(messageText, messageTimestamp) {\n  const currentYear = new Date().getFullYear();\n  const results = [];\n  \n  // æª¢æŸ¥æ—¥æœŸç¯„åœæ ¼å¼ (å¦‚: 9/1 ~ 9/5, 9/1-9/5, 8/13~8/21)\n  const rangePatterns = [\n    /(\\d{1,2})\\/(\\d{1,2})\\s*[~ï½\\-]\\s*(\\d{1,2})\\/(\\d{1,2})/,  // å®Œæ•´æ ¼å¼\n    /(\\d{1,2})\\/(\\d{1,2})\\s*[~ï½\\-]\\s*(\\d{1,2})(?!\\/)/,       // ç°¡å¯«æ ¼å¼\n  ];\n  \n  for (const pattern of rangePatterns) {\n    const match = messageText.match(pattern);\n    if (match) {\n      let startMonth, startDay, endMonth, endDay;\n      \n      if (match.length === 5) {\n        startMonth = parseInt(match[1]);\n        startDay = parseInt(match[2]);\n        endMonth = parseInt(match[3]);\n        endDay = parseInt(match[4]);\n      } else if (match.length === 4) {\n        startMonth = parseInt(match[1]);\n        startDay = parseInt(match[2]);\n        endMonth = startMonth;\n        endDay = parseInt(match[3]);\n      }\n      \n      if (startMonth >= 1 && startMonth <= 12 && startDay >= 1 && startDay <= 31 &&\n          endMonth >= 1 && endMonth <= 12 && endDay >= 1 && endDay <= 31) {\n        \n        const startDate = new Date(currentYear, startMonth - 1, startDay);\n        const endDate = new Date(currentYear, endMonth - 1, endDay);\n        \n        // è™•ç†è·¨å¹´\n        if (endDate < startDate) {\n          endDate.setFullYear(currentYear + 1);\n        }\n        \n        // èª¿æ•´å¹´ä»½ - æ”¹é€²é‚è¼¯ï¼šè€ƒæ…®è¨Šæ¯ç™¼é€æ™‚é–“èˆ‡è«‹å‡æ—¥æœŸçš„é—œä¿‚\n        const messageDate = new Date(messageTimestamp);\n        const daysDiff = (messageDate - startDate) / (1000 * 60 * 60 * 24);\n        \n        // å¦‚æœæ—¥æœŸåœ¨æœªä¾†ï¼ˆä¾‹å¦‚è¨Šæ¯åœ¨ 10 æœˆæåˆ° 9 æœˆçš„æ—¥æœŸï¼‰ï¼Œåˆ¤å®šç‚ºå»å¹´\n        if (daysDiff > 0 && daysDiff < 60 && messageDate.getMonth() > startMonth - 1) {\n          // è¨Šæ¯ç™¼é€æœˆä»½æ™šæ–¼è«‹å‡æœˆä»½ï¼Œä¸”å·®è·å°æ–¼ 60 å¤©ï¼Œåˆ¤å®šç‚ºå»å¹´\n          startDate.setFullYear(currentYear - 1);\n          endDate.setFullYear(currentYear - 1);\n        } else if (daysDiff > 180) {\n          startDate.setFullYear(currentYear + 1);\n          endDate.setFullYear(currentYear + 1);\n        } else if (daysDiff < -180) {\n          startDate.setFullYear(currentYear - 1);\n          endDate.setFullYear(currentYear - 1);\n        }\n        \n        // ç”¢ç”Ÿæ—¥æœŸç¯„åœå…§çš„æ‰€æœ‰æ—¥æœŸï¼ˆæ’é™¤é€±æœ«ï¼‰\n        const currentDate = new Date(startDate);\n        while (currentDate <= endDate) {\n          const dayOfWeek = currentDate.getDay();\n          // 0 æ˜¯é€±æ—¥ï¼Œ6 æ˜¯é€±å…­ï¼Œæ’é™¤é€™å…©å¤©\n          if (dayOfWeek !== 0 && dayOfWeek !== 6) {\n            results.push({\n              date: currentDate.toLocaleDateString('zh-TW', {\n                timeZone: taipeiTimeZone,\n                year: 'numeric',\n                month: '2-digit',\n                day: '2-digit'\n              }),\n              status: null\n            });\n          }\n          currentDate.setDate(currentDate.getDate() + 1);\n        }\n        \n        return results;\n      }\n    }\n  }\n  \n  // æª¢æŸ¥å–®ä¸€æ—¥æœŸ\n  const singlePatterns = [\n    /(\\d{1,2})\\/(\\d{1,2})/,\n    /(\\d{1,2})æœˆ(\\d{1,2})æ—¥?/,\n  ];\n  \n  for (const pattern of singlePatterns) {\n    const match = messageText.match(pattern);\n    if (match) {\n      const month = parseInt(match[1]);\n      const day = parseInt(match[2]);\n      \n      if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {\n        const leaveDate = new Date(currentYear, month - 1, day);\n        \n        // æª¢æŸ¥æ˜¯å¦ç‚ºé€±æœ«\n        const dayOfWeek = leaveDate.getDay();\n        if (dayOfWeek === 0 || dayOfWeek === 6) {\n          // å¦‚æœæ˜¯é€±æœ«ï¼Œè·³éä¸è¨˜éŒ„\n          console.log(`è·³éé€±æœ«: ${month}/${day}`);\n          return results;\n        }\n        \n        const messageDate = new Date(messageTimestamp);\n        const daysDiff = (messageDate - leaveDate) / (1000 * 60 * 60 * 24);\n        if (daysDiff > 180) {\n          leaveDate.setFullYear(currentYear + 1);\n        } else if (daysDiff < -180) {\n          leaveDate.setFullYear(currentYear - 1);\n        }\n        \n        results.push({\n          date: leaveDate.toLocaleDateString('zh-TW', {\n            timeZone: taipeiTimeZone,\n            year: 'numeric',\n            month: '2-digit',\n            day: '2-digit'\n          }),\n          status: null\n        });\n        return results;\n      }\n    }\n  }\n  \n  // å¦‚æœæ‰¾ä¸åˆ°æ—¥æœŸï¼Œè¿”å›è¨Šæ¯ç™¼é€æ—¥æœŸï¼ˆä½†æª¢æŸ¥æ˜¯å¦ç‚ºé€±æœ«ï¼‰\n  const defaultDate = new Date(messageTimestamp);\n  const dayOfWeek = defaultDate.getDay();\n  \n  if (dayOfWeek !== 0 && dayOfWeek !== 6) {\n    results.push({\n      date: defaultDate.toLocaleDateString('zh-TW', {\n        timeZone: taipeiTimeZone,\n        year: 'numeric',\n        month: '2-digit',\n        day: '2-digit'\n      }),\n      status: null\n    });\n  }\n  \n  return results;\n}\n\n// === ä¸»è¦è™•ç†é‚è¼¯ ===\nfor (const item of messages) {\n  const message = item.json;\n  if (!message.text) continue;\n  \n  // éæ¿¾ç³»çµ±è¨Šæ¯ï¼ˆåŠ å…¥/é›¢é–‹é »é“ç­‰ï¼‰\n  const systemMessagePatterns = [\n    /å·²åŠ å…¥é »é“/,\n    /å·²é›¢é–‹é »é“/,\n    /åŠ å…¥äº† #/,\n    /set the channel/,\n    /renamed the channel/,\n    /uploaded a file/,\n    /^slackbot$/i\n  ];\n  \n  const isSystemMessage = systemMessagePatterns.some(pattern => \n    pattern.test(message.text)\n  );\n  \n  if (isSystemMessage) {\n    continue; // è·³éç³»çµ±è¨Šæ¯\n  }\n  \n  const messageTimestamp = parseFloat(message.ts) * 1000;\n  const messageTime = new Date(messageTimestamp);\n  \n  // å…ˆå˜—è©¦è§£ææ—¥æœŸèˆ‡å‡åˆ¥ä¸€å°ä¸€å°æ‡‰çš„æ ¼å¼\n  const mappingResults = parseDateLeaveMapping(message.text, messageTimestamp);\n  \n  if (mappingResults.length > 0) {\n    // ä½¿ç”¨å°æ‡‰æ ¼å¼çš„è§£æçµæœ\n    const timeStr = messageTime.toLocaleTimeString('zh-TW', { \n      timeZone: taipeiTimeZone,\n      hour: '2-digit', \n      minute: '2-digit',\n      hour12: false\n    });\n    \n    for (const result of mappingResults) {\n      attendanceData.push({\n        date: result.date,\n        messageDate: messageTime.toLocaleDateString('zh-TW', { \n          timeZone: taipeiTimeZone,\n          year: 'numeric',\n          month: '2-digit',\n          day: '2-digit'\n        }),\n        time: timeStr,\n        userName: result.userName,\n        userId: null,\n        status: result.status,\n        details: replaceUserIdsWithNames(message.text)\n      });\n    }\n  } else {\n    // åŸæœ¬çš„è™•ç†é‚è¼¯\n    const userInfo = extractActualUser(message.text);\n    if (!userInfo) continue;\n    \n    let userName = userInfo.userName || 'Unknown';\n    \n    // è§£æè«‹å‡æ—¥æœŸï¼ˆå¯èƒ½æ˜¯ç¯„åœï¼‰\n    const actualLeaveDates = extractLeaveDates(message.text, messageTimestamp);\n    \n    // è§£æè«‹å‡ç‹€æ…‹\n    const status = parseMessageStatus(message.text);\n    \n    const timeStr = messageTime.toLocaleTimeString('zh-TW', { \n      timeZone: taipeiTimeZone,\n      hour: '2-digit', \n      minute: '2-digit',\n      hour12: false\n    });\n    \n    // ç‚ºæ¯å€‹æ—¥æœŸå»ºç«‹è¨˜éŒ„\n    for (const leaveInfo of actualLeaveDates) {\n      attendanceData.push({\n        date: leaveInfo.date,\n        messageDate: messageTime.toLocaleDateString('zh-TW', { \n          timeZone: taipeiTimeZone,\n          year: 'numeric',\n          month: '2-digit',\n          day: '2-digit'\n        }),\n        time: timeStr,\n        userName: userName,\n        userId: userInfo.userId || null,\n        status: status,\n        details: replaceUserIdsWithNames(message.text)\n      });\n    }\n  }\n}\n\n// æŒ‰æ—¥æœŸå’Œä½¿ç”¨è€…åˆ†çµ„çµ±è¨ˆ\nconst userStats = {};\nfor (const record of attendanceData) {\n  const key = `${record.userName}_${record.date}`;\n  if (!userStats[key]) {\n    userStats[key] = {\n      userName: record.userName,\n      userId: record.userId,\n      date: record.date,\n      messageDate: record.messageDate,\n      firstCheckIn: record.time,\n      lastCheckOut: record.time,\n      status: record.status,\n      details: record.details,\n      messageCount: 1\n    };\n  } else {\n    userStats[key].lastCheckOut = record.time;\n    userStats[key].messageCount++;\n    if (record.status !== 'æ­£å¸¸ä¸Šç­') {\n      userStats[key].status = record.status;\n      userStats[key].details = record.details;\n    }\n  }\n}\n\n// æ•´ç†æœ€çµ‚çµæœ\nconst finalResults = Object.values(userStats).map(stat => {\n  let workDuration = '';\n  if (stat.firstCheckIn !== stat.lastCheckOut) {\n    const [startHour, startMin] = stat.firstCheckIn.split(':').map(Number);\n    const [endHour, endMin] = stat.lastCheckOut.split(':').map(Number);\n    const durationMinutes = (endHour * 60 + endMin) - (startHour * 60 + startMin);\n    if (durationMinutes > 0) {\n      const hours = Math.floor(durationMinutes / 60);\n      const minutes = durationMinutes % 60;\n      workDuration = `${hours}å°æ™‚${minutes}åˆ†é˜`;\n    }\n  }\n  \n  return {\n    ...stat,\n    workDuration: workDuration\n  };\n});\n\n// æ’åº\nfinalResults.sort((a, b) => {\n  const dateCompare = b.date.localeCompare(a.date);\n  if (dateCompare !== 0) return dateCompare;\n  return a.userName.localeCompare(b.userName, 'zh-TW');\n});\n\n// çµ±è¨ˆæ‘˜è¦\nconst summary = {\n  totalRecords: finalResults.length,\n  uniqueUsers: [...new Set(finalResults.map(r => r.userName))].length,\n  dateRange: {\n    from: finalResults.length > 0 ? finalResults[finalResults.length - 1].date : '',\n    to: finalResults.length > 0 ? finalResults[0].date : ''\n  },\n  statusBreakdown: {}\n};\n\n// çµ±è¨ˆå„ç¨®ç‹€æ…‹\nfinalResults.forEach(record => {\n  const status = record.status;\n  summary.statusBreakdown[status] = (summary.statusBreakdown[status] || 0) + 1;\n});\n\n// é™¤éŒ¯è³‡è¨Š\nconsole.log(\"=== è™•ç†å®Œæˆ ===\");\nconsole.log(\"ç¸½è¨˜éŒ„æ•¸ï¼š\", finalResults.length);\nconsole.log(\"ç‹€æ…‹çµ±è¨ˆï¼š\", summary.statusBreakdown);\n\n// æª¢æŸ¥ RD-Bread 9æœˆè¨˜éŒ„\nconst breadSeptRecords = finalResults.filter(r => \n  r.userName === 'RD-Bread' && \n  r.date && r.date.includes('/09/')\n);\nconsole.log(`\\nRD-Bread 9æœˆè«‹å‡å¤©æ•¸: ${breadSeptRecords.length}`);\nif (breadSeptRecords.length > 0) {\n  console.log(\"RD-Bread 9æœˆè«‹å‡æ—¥æœŸ:\");\n  breadSeptRecords.forEach(r => {\n    console.log(`  ${r.date}: ${r.status}`);\n  });\n}\n\n// æª¢æŸ¥ PM-Mark 9æœˆè¨˜éŒ„\nconst markSeptRecords = finalResults.filter(r => \n  r.userName === 'PM-Mark' && \n  r.date && r.date.includes('/09/')\n);\nconsole.log(`\\nPM-Mark 9æœˆè«‹å‡å¤©æ•¸: ${markSeptRecords.length}`);\nif (markSeptRecords.length > 0) {\n  console.log(\"PM-Mark 9æœˆè«‹å‡æ—¥æœŸ:\");\n  markSeptRecords.forEach(r => {\n    console.log(`  ${r.date}: ${r.status}`);\n  });\n}\n\nreturn {\n  summary: summary,\n  records: finalResults,\n  rawDataCount: attendanceData.length\n};"
      },
      "id": "0ce6f4fa-1b92-4a63-be64-ba00fce19c66",
      "name": "è§£æå‡ºç¼ºå‹¤è³‡æ–™",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1232,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "// å–å¾—è¼¸å…¥è³‡æ–™\nconst inputData = $input.first().json;\nconst records = inputData.records || [];\n\n// å–å¾—ä»Šå¤©æ—¥æœŸï¼ˆå°åŒ—æ™‚å€ï¼‰\nconst today = new Date();\nconst todayStr = today.toLocaleDateString('zh-TW', {\n  timeZone: 'Asia/Taipei',\n  year: 'numeric',\n  month: '2-digit',\n  day: '2-digit'\n});\n\nconsole.log(\"ä»Šå¤©æ—¥æœŸ:\", todayStr);\nconsole.log(\"ç¸½è¨˜éŒ„æ•¸:\", records.length);\n\n// éæ¿¾ä»Šå¤©çš„è«‹å‡è¨˜éŒ„\nconst todayLeaves = records.filter(record => {\n  if (!record) return false;\n  \n  // æª¢æŸ¥æ—¥æœŸ\n  let recordDate = record.date;\n  if (!recordDate) return false;\n  \n  // æ¨™æº–åŒ–æ—¥æœŸæ ¼å¼\n  if (typeof recordDate === 'string') {\n    recordDate = recordDate.trim();\n    if (recordDate.includes('-')) {\n      recordDate = recordDate.replace(/-/g, '/');\n    }\n  }\n  \n  // æ¯”å°æ—¥æœŸ\n  const matchesDate = recordDate === todayStr;\n  \n  // æª¢æŸ¥æ˜¯å¦ç‚ºè«‹å‡ï¼ˆä¸æ˜¯æ­£å¸¸ä¸Šç­ï¼‰\n  const isLeave = record.status && \n                  record.status !== 'æ­£å¸¸ä¸Šç­' && \n                  record.status !== '';\n  \n  return matchesDate && isLeave;\n});\n\nconsole.log(\"ä»Šæ—¥è«‹å‡äººæ•¸:\", todayLeaves.length);\n\n// å»ºç«‹è¼¸å‡ºè³‡æ–™\nlet sheetData = todayLeaves.map(record => ({\n  date: record.date || todayStr,\n  userName: record.userName || 'æœªçŸ¥',\n  status: record.status || 'æœªçŸ¥ç‹€æ…‹',\n  checkInTime: record.firstCheckIn || record.checkInTime || '-',\n  checkOutTime: record.lastCheckOut || record.checkOutTime || '-',\n  details: record.details || 'ç„¡è©³ç´°è³‡è¨Š'\n}));\n\n// å¦‚æœæ²’æœ‰è«‹å‡è¨˜éŒ„ï¼ŒåŠ å…¥é è¨­è¨Šæ¯\nif (sheetData.length === 0) {\n  console.log(\"ä»Šæ—¥ç„¡äººè«‹å‡\");\n  sheetData = [{\n    date: todayStr,\n    userName: 'ç„¡',\n    status: 'å…¨å“¡æ­£å¸¸ä¸Šç­',\n    checkInTime: '-',\n    checkOutTime: '-',\n    details: 'ä»Šæ—¥ç„¡äººè«‹å‡'\n  }];\n}\n\nreturn sheetData;"
      },
      "id": "b7ab79a2-8d1a-44b9-8af4-ec812595eece",
      "name": "ä»Šæ—¥è«‹å‡è³‡æ–™",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1056,
        -256
      ]
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// è¨ˆç®—è«‹å‡æ™‚æ•¸å‡½æ•¸\n// ========================================\nfunction calculateLeaveHours(detailsText) {\n  if (!detailsText) {\n    return { hours: 8, days: 1, type: 'full-day' };\n  }\n\n  const text = detailsText.toLowerCase();\n\n  // æ¨¡å¼ 1: \"14-\", \"14:00-\", \"11:44~\" ç­‰ (å¾æŸæ™‚é–“åˆ°ä¸‹ç­)\n  // æ”¯æ´ - å’Œ ~ å…©ç¨®ç¬¦è™Ÿ\n  const pattern1Str = '(\\\\d{1,2}):?(\\\\d{2})?[\\\\s]*[\\\\-~][\\\\s]*(?=\\\\s|@|$|ç‰¹ä¼‘|ç—…å‡|äº‹å‡|å¹´å‡|å‡ºå·®|é ç«¯)';\n  const pattern1 = new RegExp(pattern1Str);\n  const match1 = text.match(pattern1);\n  if (match1) {\n    const startHour = parseInt(match1[1]);\n    const startMin = match1[2] ? parseInt(match1[2]) : 0;\n    const endHour = 18; // å‡è¨­ä¸‹ç­æ™‚é–“ 18:00\n    const endMin = 0;\n    const totalMinutes = (endHour * 60 + endMin) - (startHour * 60 + startMin);\n    const hours = Math.max(0, totalMinutes / 60);\n    return {\n      hours: hours,\n      days: hours / 8,\n      type: 'partial',\n      description: startHour + ':' + startMin.toString().padStart(2, '0') + 'åˆ°ä¸‹ç­ï¼ˆ' + hours.toFixed(1) + 'å°æ™‚ï¼‰'\n    };\n  }\n\n  // æ¨¡å¼ 2: \"14:00-18:00\" æˆ– \"14:00~18:00\" (æ˜ç¢ºçš„æ™‚é–“ç¯„åœ)\n  const pattern2Str = '(\\\\d{1,2}):(\\\\d{2})[\\\\s]*[\\\\-~][\\\\s]*(\\\\d{1,2}):(\\\\d{2})';\n  const pattern2 = new RegExp(pattern2Str);\n  const match2 = text.match(pattern2);\n  if (match2) {\n    const startHour = parseInt(match2[1]);\n    const startMin = parseInt(match2[2]);\n    const endHour = parseInt(match2[3]);\n    const endMin = parseInt(match2[4]);\n    const totalMinutes = (endHour * 60 + endMin) - (startHour * 60 + startMin);\n    const hours = totalMinutes / 60;\n    return {\n      hours: hours,\n      days: hours / 8,\n      type: 'partial',\n      description: hours.toFixed(1) + 'å°æ™‚'\n    };\n  }\n\n  // æ¨¡å¼ 3: \"ä¸Šåˆ\" (09:00-12:00 = 3å°æ™‚)\n  if (text.includes('ä¸Šåˆ')) {\n    return { hours: 3, days: 3/8, type: 'morning', description: 'ä¸Šåˆï¼ˆ3å°æ™‚ï¼‰' };\n  }\n\n  // æ¨¡å¼ 4: \"ä¸‹åˆ\" (14:00-18:00 = 4å°æ™‚)\n  if (text.includes('ä¸‹åˆ')) {\n    return { hours: 4, days: 4/8, type: 'afternoon', description: 'ä¸‹åˆï¼ˆ4å°æ™‚ï¼‰' };\n  }\n\n  // æ¨¡å¼ 5: \"åŠå¤©\"\n  if (text.includes('åŠå¤©')) {\n    return { hours: 4, days: 4/8, type: 'half-day', description: 'åŠå¤©ï¼ˆ4å°æ™‚ï¼‰' };\n  }\n\n  // é è¨­ï¼šå…¨å¤© 8 å°æ™‚\n  return { hours: 8, days: 1, type: 'full-day', description: 'å…¨å¤©ï¼ˆ8å°æ™‚ï¼‰' };\n}\n\nconst data = $input.first().json;\nconst year2025Records = data.records.filter(record => {\n  return record.date && record.date.startsWith('2025');\n});\n\n// é©—è­‰æ˜¯å¦ç‚ºæœ‰æ•ˆçš„ä½¿ç”¨è€…åç¨±\nfunction isValidUserName(name) {\n  if (!name || typeof name !== 'string') return false;\n  \n  const trimmedName = name.trim();\n  \n  // æ’é™¤ Unknown\n  if (trimmedName.toLowerCase() === 'unknown') return false;\n  \n  // æ’é™¤æ˜é¡¯ä¸æ˜¯ä½¿ç”¨è€…åç¨±çš„å…§å®¹\n  const invalidPatterns = [\n    /^\\d+\\/\\d+$/,                    // æ—¥æœŸæ ¼å¼ (å¦‚ \"1/16\")\n    /^\\d{3,4}[~\\-]\\d{3,4}$/,         // æ™‚é–“ç¯„åœ (å¦‚ \"1730~1800\")\n    /^\\d+\\./,                        // æ•¸å­—é–‹é ­åŠ å¥é» (å¦‚ \"15.\")\n    /è…¸èƒƒç‚|ç—…å‡|ç‰¹ä¼‘|å¹´å‡|å‡ºå·®/,      // è«‹å‡é¡å‹é—œéµå­—\n    /ä¹‹å¾Œæ”¹|å¾…ç¢ºèª|æš«å®š/,              // å‚™è¨»æ–‡å­—\n  ];\n  \n  if (invalidPatterns.some(pattern => pattern.test(trimmedName))) {\n    return false;\n  }\n  \n  // æ­£å‘é©—è­‰ï¼šæª¢æŸ¥æ˜¯å¦ç¬¦åˆæœ‰æ•ˆçš„ä½¿ç”¨è€…åç¨±æ ¼å¼\n  const validPatterns = [\n    /^[a-zA-Z]+\\.[a-zA-Z]+$/,           // è‹±æ–‡å.å§“æ°ç¸®å¯« (å¦‚ ryan.l)\n    /^[a-zA-Z]+_[a-zA-Z]+$/,            // è‹±æ–‡å_å§“æ°\n    /^[a-zA-Z]+\\-[a-zA-Z]+$/,           // éƒ¨é–€-åå­—æ ¼å¼ (å¦‚ RD-Alan)\n    /^[a-zA-Z][a-zA-Z0-9._\\-]{1,30}$/,  // ä¸€èˆ¬è‹±æ–‡ä½¿ç”¨è€…åç¨±\n    /^[\\u4e00-\\u9fa5]{2,5}$/,           // ä¸­æ–‡åå­—ï¼ˆ2-5å€‹å­—ï¼‰\n    /^[A-Za-z]+[-\\s][\\u4e00-\\u9fa5\\w\\s]+$/, // éƒ¨é–€-ä¸­è‹±æ–‡æ··åˆ (å¦‚ Math-Mike Tsai)\n    /^U[A-Z0-9]{10,12}$/                // Slack User ID æ ¼å¼\n  ];\n  \n  return validPatterns.some(pattern => pattern.test(trimmedName));\n}\n\nconst leaveStats = {};\nconst invalidRecords = [];\nconst unknownStatuses = new Set(); // æ”¶é›†æœªåˆ†é¡çš„ç‹€æ…‹\nlet unknownCount = 0; // è¨ˆç®—è¢«æ’é™¤çš„ Unknown è¨˜éŒ„æ•¸\n\nyear2025Records.forEach(record => {\n  // å…ˆæª¢æŸ¥æ˜¯å¦ç‚º Unknown\n  if (record.userName && record.userName.toLowerCase() === 'unknown') {\n    unknownCount++;\n    return; // ç›´æ¥è·³é Unknown è¨˜éŒ„\n  }\n  \n  // ä½¿ç”¨ userName æ¬„ä½ï¼Œä½†è¦å…ˆé©—è­‰\n  if (!isValidUserName(record.userName)) {\n    invalidRecords.push({\n      date: record.date,\n      userName: record.userName,\n      status: record.status,\n      details: record.details,\n      issue: 'ç„¡æ•ˆçš„ä½¿ç”¨è€…åç¨±'\n    });\n    return;\n  }\n  \n  if (record.status && record.status !== 'æ­£å¸¸ä¸Šç­') {\n    const userName = record.userName;\n    \n    if (!leaveStats[userName]) {\n      leaveStats[userName] = {\n        userName: userName,\n        totalDays: 0,\n        totalHours: 0,       // ç¸½æ™‚æ•¸\n        sickLeave: 0,\n        sickLeaveHours: 0,        // ç—…å‡\n        sickLeaveHours: 0,   // ç—…å‡æ™‚æ•¸\n        annualLeave: 0,\n        annualLeaveHours: 0,      // ç‰¹ä¼‘/å¹´å‡\n        businessTrip: 0,\n        businessTripHours: 0,     // å‡ºå·®/å…¬å‡º\n        remote: 0,\n        remoteHours: 0,           // é ç«¯å·¥ä½œ\n        personalLeave: 0,\n        personalLeaveHours: 0,    // äº‹å‡\n        marriageLeave: 0,\n        marriageLeaveHours: 0,    // å©šå‡\n        bereavementLeave: 0,\n        bereavementLeaveHours: 0, // å–ªå‡\n        maternityLeave: 0,\n        maternityLeaveHours: 0,   // ç”¢å‡/é™ªç”¢å‡\n        menstrualLeave: 0,\n        menstrualLeaveHours: 0,   // ç”Ÿç†å‡\n        compensatoryLeave: 0,\n        compensatoryLeaveHours: 0,// è£œä¼‘\n        officialLeave: 0,\n        officialLeaveHours: 0,    // å…¬å‡\n        birthdayLeave: 0,\n        birthdayLeaveHours: 0,    // ç”Ÿæ—¥å‡\n        others: 0,\n        othersHours: 0,           // å…¶ä»–æœªåˆ†é¡\n        halfDayCount: 0      // åŠå¤©å‡æ¬¡æ•¸\n      };\n    }\n    \n    // ä½¿ç”¨æ–°çš„æ™‚æ•¸è¨ˆç®—å‡½æ•¸\n    const leaveInfo = calculateLeaveHours(record.details);\n    const daysToAdd = leaveInfo.days;\n    const hoursToAdd = leaveInfo.hours;\n    leaveStats[userName].totalDays += daysToAdd;\n    leaveStats[userName].totalHours += hoursToAdd;\n    \n    if (isHalfDay) {\n      leaveStats[userName].halfDayCount++;\n    }\n    \n    // æ ¹æ“šç‹€æ…‹åˆ†é¡\n    switch(record.status) {\n      case 'ç—…å‡':\n      case 'ç”Ÿç—…':\n      case 'çœ‹è¨º':\n      case 'å°±é†«':\n        leaveStats[userName].sickLeave += daysToAdd;\n        leaveStats[userName].sickLeaveHours += hoursToAdd;\n        break;\n        \n      case 'ç‰¹ä¼‘':\n      case 'å¹´å‡':\n      case 'ä¼‘å‡':\n        leaveStats[userName].annualLeave += daysToAdd;\n        leaveStats[userName].annualLeaveHours += hoursToAdd;\n        break;\n        \n      case 'å‡ºå·®':\n      case 'å…¬å‡º':\n      case 'å¤–å‡º':\n      case 'å‡ºå…¬å·®':\n        leaveStats[userName].businessTrip += daysToAdd;\n        leaveStats[userName].businessTripHours += hoursToAdd;\n        break;\n        \n      case 'é ç«¯å·¥ä½œ':\n      case 'åœ¨å®¶å·¥ä½œ':\n      case 'remote':\n      case 'WFH':\n      case 'å±…å®¶è¾¦å…¬':\n        leaveStats[userName].remote += daysToAdd;\n        leaveStats[userName].remoteHours += hoursToAdd;\n        break;\n        \n      case 'äº‹å‡':\n      case 'ç§äº‹':\n      case 'å€‹äººäº‹å‡':\n        leaveStats[userName].personalLeave += daysToAdd;\n        leaveStats[userName].personalLeaveHours += hoursToAdd;\n        break;\n        \n      case 'å©šå‡':\n      case 'çµå©š':\n        leaveStats[userName].marriageLeave += daysToAdd;\n        leaveStats[userName].marriageLeaveHours += hoursToAdd;\n        break;\n        \n      case 'å–ªå‡':\n      case 'å¥”å–ª':\n        leaveStats[userName].bereavementLeave += daysToAdd;\n        leaveStats[userName].bereavementLeaveHours += hoursToAdd;\n        break;\n        \n      case 'ç”¢å‡':\n      case 'é™ªç”¢å‡':\n      case 'è‚²å¬°å‡':\n      case 'ç”¢æª¢å‡':\n        leaveStats[userName].maternityLeave += daysToAdd;\n        leaveStats[userName].maternityLeaveHours += hoursToAdd;\n        break;\n        \n      case 'ç”Ÿç†å‡':\n      case 'ç”Ÿç†':\n      case 'ç¶“æœŸ':\n      case 'MC':\n        leaveStats[userName].menstrualLeave += daysToAdd;\n        leaveStats[userName].menstrualLeaveHours += hoursToAdd;\n        break;\n        \n      case 'è£œä¼‘':\n      case 'è£œå‡':\n      case 'èª¿ä¼‘':\n        leaveStats[userName].compensatoryLeave += daysToAdd;\n        leaveStats[userName].compensatoryLeaveHours += hoursToAdd;\n        break;\n        \n      case 'å…¬å‡':\n      case 'æŠ•ç¥¨':\n      case 'å…µå½¹':\n      case 'å…¬å‹™':\n        leaveStats[userName].officialLeave += daysToAdd;\n        leaveStats[userName].officialLeaveHours += hoursToAdd;\n        break;\n        \n      case 'ç”Ÿæ—¥å‡':\n      case 'ç”Ÿæ—¥':\n      case 'Birthday':\n      case 'BD':\n        leaveStats[userName].birthdayLeave += daysToAdd;\n        leaveStats[userName].birthdayLeaveHours += hoursToAdd;\n        break;\n        \n      default:\n        leaveStats[userName].others += daysToAdd;\n        leaveStats[userName].othersHours += hoursToAdd;\n        unknownStatuses.add(record.status);\n    }\n  }\n});\n\nconst ranking = Object.values(leaveStats)\n  .filter(stat => stat.userName.toLowerCase() !== 'unknown') // å…ˆéæ¿¾æ‰ Unknown\n  .sort((a, b) => b.totalDays - a.totalDays)\n  .map((stat, index) => ({\n    rank: index + 1,  // é‡æ–°è¨ˆç®—æ’å\n    userName: stat.userName,\n    totalDays: stat.totalDays,\n    sickLeave: stat.sickLeave,\n    annualLeave: stat.annualLeave,\n    businessTrip: stat.businessTrip,\n    remote: stat.remote,\n    personalLeave: stat.personalLeave,\n    marriageLeave: stat.marriageLeave,\n    bereavementLeave: stat.bereavementLeave,\n    maternityLeave: stat.maternityLeave,\n    menstrualLeave: stat.menstrualLeave,\n    compensatoryLeave: stat.compensatoryLeave,\n    officialLeave: stat.officialLeave,\n    birthdayLeave: stat.birthdayLeave,\n    others: stat.others,\n    halfDayCount: stat.halfDayCount\n  }));\n\n// è¨ºæ–·è³‡è¨Š\nconsole.log('=== 2025å¹´è«‹å‡çµ±è¨ˆå ±å‘Š ===');\nconsole.log(`\\nè™•ç†äº† ${year2025Records.length} ç­† 2025 å¹´è¨˜éŒ„`);\nconsole.log(`æ’é™¤äº† ${unknownCount} ç­† Unknown è¨˜éŒ„`);\nconsole.log(`çµ±è¨ˆäº† ${Object.keys(leaveStats).length} ä½å“¡å·¥çš„è«‹å‡è¨˜éŒ„`);\n\nif (invalidRecords.length > 0) {\n  console.log(`\\nâš ï¸ ç™¼ç¾ ${invalidRecords.length} ç­†ç„¡æ•ˆè¨˜éŒ„`);\n  const uniqueInvalidNames = [...new Set(invalidRecords.map(r => r.userName))];\n  console.log('ç„¡æ•ˆçš„ä½¿ç”¨è€…åç¨±ç¯„ä¾‹:', uniqueInvalidNames.slice(0, 5));\n}\n\nif (unknownStatuses.size > 0) {\n  console.log('\\nğŸ“ æœªåˆ†é¡çš„è«‹å‡ç‹€æ…‹:');\n  Array.from(unknownStatuses).forEach(status => {\n    console.log(`  - \"${status}\"`);\n  });\n}\n\n// é¡¯ç¤ºè«‹å‡çµ±è¨ˆæ‘˜è¦\nconsole.log('\\nğŸ“Š è«‹å‡é¡å‹çµ±è¨ˆæ‘˜è¦:');\nconst totalByType = {\n  sickLeave: 0,\n  annualLeave: 0,\n  businessTrip: 0,\n  remote: 0,\n  personalLeave: 0,\n  marriageLeave: 0,\n  bereavementLeave: 0,\n  maternityLeave: 0,\n  menstrualLeave: 0,\n  compensatoryLeave: 0,\n  officialLeave: 0,\n  birthdayLeave: 0,\n  others: 0\n};\n\nranking.forEach(r => {\n  totalByType.sickLeave += r.sickLeave;\n  totalByType.annualLeave += r.annualLeave;\n  totalByType.businessTrip += r.businessTrip;\n  totalByType.remote += r.remote;\n  totalByType.personalLeave += r.personalLeave;\n  totalByType.marriageLeave += r.marriageLeave;\n  totalByType.bereavementLeave += r.bereavementLeave;\n  totalByType.maternityLeave += r.maternityLeave;\n  totalByType.menstrualLeave += r.menstrualLeave;\n  totalByType.compensatoryLeave += r.compensatoryLeave;\n  totalByType.officialLeave += r.officialLeave;\n  totalByType.birthdayLeave += r.birthdayLeave;\n  totalByType.others += r.others;\n});\n\nconsole.log(`  ç—…å‡: ${totalByType.sickLeave} å¤©`);\nconsole.log(`  ç‰¹ä¼‘/å¹´å‡: ${totalByType.annualLeave} å¤©`);\nconsole.log(`  å‡ºå·®/å…¬å‡º: ${totalByType.businessTrip} å¤©`);\nconsole.log(`  é ç«¯å·¥ä½œ: ${totalByType.remote} å¤©`);\nconsole.log(`  äº‹å‡: ${totalByType.personalLeave} å¤©`);\nconsole.log(`  å©šå‡: ${totalByType.marriageLeave} å¤©`);\nconsole.log(`  å–ªå‡: ${totalByType.bereavementLeave} å¤©`);\nconsole.log(`  ç”¢å‡/é™ªç”¢å‡: ${totalByType.maternityLeave} å¤©`);\nconsole.log(`  ç”Ÿç†å‡: ${totalByType.menstrualLeave} å¤©`);\nconsole.log(`  è£œä¼‘: ${totalByType.compensatoryLeave} å¤©`);\nconsole.log(`  å…¬å‡: ${totalByType.officialLeave} å¤©`);\nconsole.log(`  ç”Ÿæ—¥å‡: ${totalByType.birthdayLeave} å¤©`);\nconsole.log(`  å…¶ä»–: ${totalByType.others} å¤©`);\n\n// é¡¯ç¤ºå‰10åè«‹å‡æœ€å¤šçš„å“¡å·¥\nconsole.log('\\nğŸ† è«‹å‡å¤©æ•¸æ’è¡Œæ¦œ Top 10:');\nranking.slice(0, 10).forEach(r => {\n  let details = [];\n  if (r.annualLeave > 0) details.push(`ç‰¹ä¼‘:${r.annualLeave}`);\n  if (r.sickLeave > 0) details.push(`ç—…å‡:${r.sickLeave}`);\n  if (r.remote > 0) details.push(`é ç«¯:${r.remote}`);\n  if (r.businessTrip > 0) details.push(`å‡ºå·®:${r.businessTrip}`);\n  if (r.personalLeave > 0) details.push(`äº‹å‡:${r.personalLeave}`);\n  if (r.menstrualLeave > 0) details.push(`ç”Ÿç†å‡:${r.menstrualLeave}`);\n  if (r.birthdayLeave > 0) details.push(`ç”Ÿæ—¥å‡:${r.birthdayLeave}`);\n  if (r.compensatoryLeave > 0) details.push(`è£œä¼‘:${r.compensatoryLeave}`);\n  if (r.marriageLeave > 0) details.push(`å©šå‡:${r.marriageLeave}`);\n  if (r.bereavementLeave > 0) details.push(`å–ªå‡:${r.bereavementLeave}`);\n  if (r.maternityLeave > 0) details.push(`ç”¢å‡:${r.maternityLeave}`);\n  if (r.officialLeave > 0) details.push(`å…¬å‡:${r.officialLeave}`);\n  if (r.others > 0) details.push(`å…¶ä»–:${r.others}`);\n  if (r.halfDayCount > 0) details.push(`å«${r.halfDayCount}æ¬¡åŠå¤©`);\n  \n  console.log(`  ${r.rank}. ${r.userName}: ${r.totalDays}å¤© (${details.join(', ')})`);\n});\n\n// ç‰¹åˆ¥çµ±è¨ˆï¼šä½¿ç”¨ç”Ÿæ—¥å‡çš„å“¡å·¥\nconst birthdayLeaveUsers = ranking.filter(r => r.birthdayLeave > 0);\nif (birthdayLeaveUsers.length > 0) {\n  console.log('\\nğŸ‚ ä½¿ç”¨ç”Ÿæ—¥å‡çš„å“¡å·¥:');\n  birthdayLeaveUsers.forEach(user => {\n    console.log(`  - ${user.userName}: ${user.birthdayLeave} å¤©`);\n  });\n}\n\n// ç‰¹åˆ¥çµ±è¨ˆï¼šä½¿ç”¨ç”Ÿç†å‡çš„å“¡å·¥\nconst menstrualLeaveUsers = ranking.filter(r => r.menstrualLeave > 0);\nif (menstrualLeaveUsers.length > 0) {\n  console.log('\\nğŸ©º ä½¿ç”¨ç”Ÿç†å‡çš„å“¡å·¥:');\n  menstrualLeaveUsers.forEach(user => {\n    console.log(`  - ${user.userName}: ${user.menstrualLeave} å¤©`);\n  });\n}\n\nreturn ranking;"
      },
      "id": "9d526cfe-f498-496a-a6a5-610690975d42",
      "name": "2025å¹´æ’è¡Œæ¦œ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -992,
        240
      ]
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "resource": "channel",
        "operation": "history",
        "channelId": {
          "__rl": true,
          "value": "C05FXLH7BCJ",
          "mode": "list",
          "cachedResultName": "jvdæ¯æ—¥å‡ºå‹¤å›å ±"
        },
        "returnAll": true,
        "filters": {}
      },
      "id": "ad58d52c-efd9-471b-b794-e4bcd6016c09",
      "name": "å–å¾—é »é“è³‡è¨Š",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [
        -1440,
        240
      ],
      "webhookId": "b6c1ebff-0cc6-4bfd-85d3-d0f73abed2f9",
      "alwaysOutputData": false,
      "credentials": {
        "slackOAuth2Api": {
          "id": "uB8nqjfDBs738eff",
          "name": "n8n-ops"
        }
      }
    },
    {
      "parameters": {
        "operation": "clear",
        "documentId": {
          "__rl": true,
          "value": "176_Vy1vjv-_-At94RmPp6mAT9TwMjme3QF7_UPo-fDw",
          "mode": "list",
          "cachedResultName": "å‡ºå‹¤çµ±è¨ˆ",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/176_Vy1vjv-_-At94RmPp6mAT9TwMjme3QF7_UPo-fDw/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 205325504,
          "mode": "list",
          "cachedResultName": "2025æ’è¡Œæ¦œ",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/176_Vy1vjv-_-At94RmPp6mAT9TwMjme3QF7_UPo-fDw/edit#gid=205325504"
        },
        "clear": "specificRows",
        "startIndex": 2,
        "rowsToDelete": 300
      },
      "id": "85384607-64f9-4414-b999-6b242de92a5c",
      "name": "æ¸…ç©º2025å¹´æ’è¡Œæ¦œ",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        -1504,
        -80
      ],
      "executeOnce": false,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "2jHbIbD9Qfj8dzba",
          "name": "n8n-GoogleSheet"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "176_Vy1vjv-_-At94RmPp6mAT9TwMjme3QF7_UPo-fDw",
          "mode": "list",
          "cachedResultName": "å‡ºå‹¤çµ±è¨ˆ",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/176_Vy1vjv-_-At94RmPp6mAT9TwMjme3QF7_UPo-fDw/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 205325504,
          "mode": "list",
          "cachedResultName": "2025æ’è¡Œæ¦œ",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/176_Vy1vjv-_-At94RmPp6mAT9TwMjme3QF7_UPo-fDw/edit#gid=205325504"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "rank": "={{ $json.rank }}",
            "userName": "={{ $json.userName }}",
            "totalDays": "={{ $json.totalDays }}",
            "sickLeave": "={{ $json.sickLeave }}",
            "annualLeave": "={{ $json.annualLeave }}",
            "businessTrip": "={{ $json.businessTrip }}",
            "remote": "={{ $json.remote }}",
            "personalLeave": "={{ $json.personalLeave }}",
            "birthdayLeave": "={{ $json.birthdayLeave }}",
            "marriageLeave": "={{ $json.marriageLeave }}",
            "bereavementLeave": "={{ $json.bereavementLeave }}",
            "maternityLeave": "={{ $json.maternityLeave }}",
            "compensatoryLeave": "={{ $json.compensatoryLeave }}",
            "officialLeave": "={{ $json.officialLeave }}",
            "others": "={{ $json.others }}",
            "halfDayCount": "={{ $json.halfDayCount }}",
            "menstrualLeave": "={{ $json.menstrualLeave }}",
            "totalHours": "={{ $json.totalHours }}",
            "sickLeaveHours": "={{ $json.sickLeaveHours }}",
            "annualLeaveHours": "={{ $json.annualLeaveHours }}",
            "remoteHours": "={{ $json.remoteHours }}",
            "birthdayLeaveHours": "={{ $json.birthdayLeaveHours }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "rank",
              "displayName": "rank",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "userName",
              "displayName": "userName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "totalDays",
              "displayName": "totalDays",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "sickLeave",
              "displayName": "sickLeave",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "annualLeave",
              "displayName": "annualLeave",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "businessTrip",
              "displayName": "businessTrip",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "remote",
              "displayName": "remote",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "personalLeave",
              "displayName": "personalLeave",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "birthdayLeave",
              "displayName": "birthdayLeave",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "marriageLeave",
              "displayName": "marriageLeave",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "bereavementLeave",
              "displayName": "bereavementLeave",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "maternityLeave",
              "displayName": "maternityLeave",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "menstrualLeave",
              "displayName": "menstrualLeave",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "compensatoryLeave",
              "displayName": "compensatoryLeave",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "officialLeave",
              "displayName": "officialLeave",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "others",
              "displayName": "others",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "halfDayCount",
              "displayName": "halfDayCount",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "adbe9b52-1d2b-42df-b589-d14e95419d4b",
      "name": "æ›´æ–°2025å¹´æ’è¡Œæ¦œ",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        -768,
        240
      ],
      "alwaysOutputData": false,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "2jHbIbD9Qfj8dzba",
          "name": "n8n-GoogleSheet"
        }
      }
    },
    {
      "parameters": {
        "operation": "clear",
        "documentId": {
          "__rl": true,
          "value": "176_Vy1vjv-_-At94RmPp6mAT9TwMjme3QF7_UPo-fDw",
          "mode": "list",
          "cachedResultName": "å‡ºå‹¤çµ±è¨ˆ",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/176_Vy1vjv-_-At94RmPp6mAT9TwMjme3QF7_UPo-fDw/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "ä»Šæ—¥è«‹å‡",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/176_Vy1vjv-_-At94RmPp6mAT9TwMjme3QF7_UPo-fDw/edit#gid=0"
        },
        "clear": "specificRows",
        "startIndex": 2,
        "rowsToDelete": 65535
      },
      "id": "0ebcb646-77a3-4585-ac89-dd07647ee946",
      "name": "æ¸…ç©ºä»Šæ—¥è«‹å‡",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        -1680,
        -80
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "2jHbIbD9Qfj8dzba",
          "name": "n8n-GoogleSheet"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "176_Vy1vjv-_-At94RmPp6mAT9TwMjme3QF7_UPo-fDw",
          "mode": "list",
          "cachedResultName": "å‡ºå‹¤çµ±è¨ˆ",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/176_Vy1vjv-_-At94RmPp6mAT9TwMjme3QF7_UPo-fDw/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "ä»Šæ—¥è«‹å‡",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/176_Vy1vjv-_-At94RmPp6mAT9TwMjme3QF7_UPo-fDw/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "date": "={{ $json.date }}",
            "userName": "={{ $json.userName }}",
            "status": "={{ $json.status }}",
            "checkInTime": "={{ $json.checkInTime }}",
            "checkOutTime": "={{ $json.checkOutTime }}",
            "details": "={{ $json.details }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "date",
              "displayName": "date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "userName",
              "displayName": "userName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "checkInTime",
              "displayName": "checkInTime",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "checkOutTime",
              "displayName": "checkOutTime",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "details",
              "displayName": "details",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "workDuration",
              "displayName": "workDuration",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "c61b1eea-8fff-4729-bc93-17af64caccbb",
      "name": "æ›´æ–°ä»Šæ—¥è«‹å‡",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        -864,
        -64
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "2jHbIbD9Qfj8dzba",
          "name": "n8n-GoogleSheet"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// è¨ˆç®—å‡ºå‹¤è³‡æ–™çš„ hash å€¼ï¼Œç”¨æ–¼æª¢æ¸¬è®Šæ›´\nfunction calculateAttendanceHash(records) {\n  if (!records || records.length === 0) {\n    return 'EMPTY';\n  }\n  \n  const sorted = records\n    .map(r => `${r.userName}:${r.status}`)\n    .sort()\n    .join('|');\n  \n  return sorted;\n}\n\n// è™•ç†è«‹å‡è³‡æ–™ä¸¦æº–å‚™ Slack è¨Šæ¯\nconst CHANNEL_NAME = \"opsæ¯æ—¥å‡ºå‹¤å›å ±\";\nconst SHEET_URL = \"https://docs.google.com/spreadsheets/d/176_Vy1vjv-_-At94RmPp6mAT9TwMjme3QF7_UPo-fDw/edit?gid=0#gid=0\";\n\n// å–å¾—è¼¸å…¥è³‡æ–™\nconst inputItems = $input.all();\nconst statusInfo = $node[\"æª¢æŸ¥è¨Šæ¯ç‹€æ…‹\"].json;\n\n// å–å¾—ä»Šå¤©æ—¥æœŸï¼ˆå°åŒ—æ™‚å€ï¼‰\nconst now = new Date();\nconst currentDate = now.toLocaleDateString('zh-TW', {\n  timeZone: 'Asia/Taipei',\n  year: 'numeric',\n  month: '2-digit',\n  day: '2-digit'\n});\n\n// æ ¼å¼åŒ–ç‚º M/D æ ¼å¼\nconst month = now.getMonth() + 1;\nconst day = now.getDate();\nconst shortDate = `${month}/${day}`;\n\n// å–å¾—ç•¶å‰æ™‚é–“\nconst currentTime = now.toLocaleTimeString('zh-TW', {\n  timeZone: 'Asia/Taipei',\n  hour: '2-digit',\n  minute: '2-digit',\n  hour12: false\n});\n\n// ç¯©é¸ä»Šæ—¥çš„è«‹å‡è¨˜éŒ„\nconst todayLeaves = [];\nfor (const item of inputItems) {\n  const record = item.json || item;\n  \n  // æª¢æŸ¥æ˜¯å¦ç‚ºä»Šæ—¥è«‹å‡è¨˜éŒ„\n  if (record.date === currentDate && \n      record.status && \n      record.status !== 'æ­£å¸¸ä¸Šç­' &&\n      record.userName && \n      record.userName.toLowerCase() !== 'unknown' &&\n      record.userName !== 'ç„¡') {\n    todayLeaves.push(record);\n  }\n}\n\n// æŒ‰ç‹€æ…‹åˆ†çµ„\nconst statusGroups = {};\ntodayLeaves.forEach(record => {\n  const status = record.status;\n  if (!statusGroups[status]) {\n    statusGroups[status] = [];\n  }\n  statusGroups[status].push(record.userName);\n});\n\n// å»ºç«‹ Slack è¨Šæ¯\nlet slackText = '';\n\nif (todayLeaves.length === 0) {\n  slackText = `ğŸ“… *${shortDate} å‡ºå‹¤ç‹€æ³*\\nâœ… ä»Šæ—¥ç„¡äººè«‹å‡`;\n} else {\n  // æ¨™é¡Œè¡Œ\n  slackText = `ğŸ“… *${shortDate} å‡ºå‹¤ç‹€æ³*\\nğŸ‘¥ å…± ${todayLeaves.length} äººè«‹å‡/é ç«¯\\n\\n`;\n  \n  // ç‹€æ…‹ emoji å°æ‡‰\n  const statusEmojis = {\n    'é ç«¯å·¥ä½œ': 'ğŸ’»',\n    'åœ¨å®¶å·¥ä½œ': 'ğŸ ',\n    'ç—…å‡': 'ğŸ¥',\n    'äº‹å‡': 'ğŸ“',\n    'ç‰¹ä¼‘': 'ğŸ–ï¸',\n    'å¹´å‡': 'âœˆï¸',\n    'ç”Ÿæ—¥å‡': 'ğŸ‚',\n    'å‡ºå·®': 'ğŸš—',\n    'å…¬å‡º': 'ğŸ¢'\n  };\n  \n  // æŒ‰ç‹€æ…‹åˆ†çµ„é¡¯ç¤º\n  for (const [status, names] of Object.entries(statusGroups)) {\n    const emoji = statusEmojis[status] || 'ğŸ“Œ';\n    slackText += `${emoji} *${status}*\\n`;\n    names.forEach(name => {\n      slackText += `â€¢ ${name}\\n`;\n    });\n    slackText += '\\n';\n  }\n}\n\n// åŠ å…¥æ›´æ–°æ™‚é–“å’Œé€£çµ\nslackText += `\\n_æœ€å¾Œæ›´æ–°: ${currentTime}_\\n`;\nslackText += `<${SHEET_URL}|ğŸ“Š æŸ¥çœ‹å®Œæ•´çµ±è¨ˆ>`;\n\n// è¼¸å‡ºçµ¦ Slack ç¯€é»\nreturn [{\n  text: slackText,\n  channel: CHANNEL_NAME,\n  shouldSendNewMessage: statusInfo.shouldSendNewMessage,\n  messageTs: statusInfo.messageTs,\n  metadata: {\n    date: currentDate,\n    shortDate: shortDate,\n    totalCount: todayLeaves.length,\n    records: todayLeaves,\n    sheetUrl: SHEET_URL,\n    updateTime: currentTime\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -864,
        -256
      ],
      "id": "0d03a70c-c9c6-4e22-b648-fec9c45cb981",
      "name": "è™•ç†è«‹å‡è³‡æ–™",
      "executeOnce": false,
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "change_detection",
              "leftValue": "={{ $json.attendanceHash }}",
              "rightValue": "={{ $json.previousHash }}",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -480,
        -256
      ],
      "id": "cff0907e-06ae-4f05-b4ee-efdec9491f18",
      "name": "If"
    },
    {
      "parameters": {
        "jsCode": "const now = new Date();\nconst taipeiTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Taipei' }));\nreturn [\n  {\n    json: {\n      hour: taipeiTime.getHours().toString() // å°‡å°æ™‚æ•¸è½‰ç‚ºå­—ä¸²\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -672,
        -256
      ],
      "id": "c7a598a5-6567-4623-ad52-71c714c733da",
      "name": "GetTime"
    },
    {
      "parameters": {
        "jsCode": "// å¾å‰ä¸€å€‹ç¯€é»ç²å–è³‡æ–™\nconst items = $input.all();\n\n// è®€å–ä¸Šæ¬¡çš„å‡ºå‹¤ hashï¼ˆå¾ Slack è¨Šæ¯çš„æœ€å¾Œä¸€è¡Œï¼‰\nlet previousHash = null;\nif (items.length > 0) {\n  const messages = items;\n  if (messages.length > 0) {\n    const lastMessage = messages[0].json;\n    const text = lastMessage.text || '';\n    \n    // å¾è¨Šæ¯ä¸­æå– hash (æ ¼å¼: <!-- hash:xxxxx -->)\n    const hashMatch = text.match(/<!-- hash:(.+?) -->/);\n    if (hashMatch) {\n      previousHash = hashMatch[1];\n    }\n  }\n}\n// æª¢æŸ¥æ˜¯å¦éœ€è¦ç™¼é€æ–°è¨Šæ¯æˆ–æ›´æ–°ç¾æœ‰è¨Šæ¯\nconst now = new Date();\nconst taipeiTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Taipei' }));\nconst currentHour = taipeiTime.getHours();\nconst currentDate = taipeiTime.toDateString();\n\n// å¾ Static Data å–å¾—ä¸Šæ¬¡çš„ timestamp å’Œæ—¥æœŸ\nconst staticData = $getWorkflowStaticData('global');\nlet messageTs = staticData.messageTs || null;\nlet lastDate = staticData.lastDate || null;\n\nconsole.log('ç•¶å‰æ™‚é–“:', taipeiTime);\nconsole.log('ç•¶å‰å°æ™‚:', currentHour);\nconsole.log('å„²å­˜çš„ timestamp:', messageTs);\nconsole.log('ä¸Šæ¬¡æ—¥æœŸ:', lastDate);\nconsole.log('ç•¶å‰æ—¥æœŸ:', currentDate);\n\n// åˆ¤æ–·æ˜¯å¦éœ€è¦ç™¼é€æ–°è¨Šæ¯\n// æ¢ä»¶ï¼šæ—©ä¸Š8é» æˆ– æ–°çš„ä¸€å¤© æˆ– æ²’æœ‰ timestamp\nlet shouldSendNewMessage = false;\n\nif (!messageTs) {\n  console.log('æ²’æœ‰ timestampï¼Œéœ€è¦ç™¼é€æ–°è¨Šæ¯');\n  shouldSendNewMessage = true;\n} else if (lastDate !== currentDate && currentHour >= 8) {\n  console.log('æ–°çš„ä¸€å¤©ä¸”å·²é8é»ï¼Œéœ€è¦ç™¼é€æ–°è¨Šæ¯');\n  shouldSendNewMessage = true;\n  // æ¸…é™¤èˆŠçš„ timestamp\n  staticData.messageTs = null;\n  messageTs = null;\n} else if (currentHour === 8 && lastDate !== currentDate) {\n  console.log('æ—©ä¸Š8é»ä¸”æ˜¯æ–°çš„ä¸€å¤©ï¼Œéœ€è¦ç™¼é€æ–°è¨Šæ¯');\n  shouldSendNewMessage = true;\n  // æ¸…é™¤èˆŠçš„ timestamp\n  staticData.messageTs = null;\n  messageTs = null;\n}\n\n// æ›´æ–°æœ€å¾Œè™•ç†æ—¥æœŸ\nstaticData.lastDate = currentDate;\n\nreturn {\n  previousHash: previousHash,\n  shouldSendNewMessage,\n  messageTs,\n  currentDate,\n  currentHour,\n  taipeiTime: taipeiTime.toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' })\n};"
      },
      "id": "82f75ca4-9836-4161-b07e-2aadbcf5d3a2",
      "name": "æª¢æŸ¥è¨Šæ¯ç‹€æ…‹",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1648,
        240
      ]
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "select": "user",
        "user": {
          "__rl": true,
          "value": "U07F9203EP8",
          "mode": "list",
          "cachedResultName": "lonely.h"
        },
        "text": "={{ $('è™•ç†è«‹å‡è³‡æ–™').item.json.text }}",
        "otherOptions": {}
      },
      "id": "7205d3d9-1b56-4fe5-87aa-e2a1220dd66a",
      "name": "lonely.h",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [
        -240,
        -208
      ],
      "webhookId": "e6f7aa0e-46db-4d6d-8eba-16a722eea060",
      "credentials": {
        "slackOAuth2Api": {
          "id": "uB8nqjfDBs738eff",
          "name": "n8n-ops"
        }
      }
    }
  ],
  "connections": {
    "æ¯å°æ™‚åŸ·è¡Œ1": {
      "main": [
        [
          {
            "node": "æª¢æŸ¥è¨Šæ¯ç‹€æ…‹",
            "type": "main",
            "index": 0
          },
          {
            "node": "æ¸…ç©ºä»Šæ—¥è«‹å‡",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è§£æå‡ºç¼ºå‹¤è³‡æ–™": {
      "main": [
        [
          {
            "node": "ä»Šæ—¥è«‹å‡è³‡æ–™",
            "type": "main",
            "index": 0
          },
          {
            "node": "2025å¹´æ’è¡Œæ¦œ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ä»Šæ—¥è«‹å‡è³‡æ–™": {
      "main": [
        [
          {
            "node": "æ›´æ–°ä»Šæ—¥è«‹å‡",
            "type": "main",
            "index": 0
          },
          {
            "node": "è™•ç†è«‹å‡è³‡æ–™",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2025å¹´æ’è¡Œæ¦œ": {
      "main": [
        [
          {
            "node": "æ›´æ–°2025å¹´æ’è¡Œæ¦œ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å–å¾—é »é“è³‡è¨Š": {
      "main": [
        [
          {
            "node": "è§£æå‡ºç¼ºå‹¤è³‡æ–™",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ¸…ç©º2025å¹´æ’è¡Œæ¦œ": {
      "main": [
        []
      ]
    },
    "æ¸…ç©ºä»Šæ—¥è«‹å‡": {
      "main": [
        [
          {
            "node": "æ¸…ç©º2025å¹´æ’è¡Œæ¦œ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è™•ç†è«‹å‡è³‡æ–™": {
      "main": [
        [
          {
            "node": "GetTime",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "lonely.h",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "GetTime": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æª¢æŸ¥è¨Šæ¯ç‹€æ…‹": {
      "main": [
        [
          {
            "node": "å–å¾—é »é“è³‡è¨Š",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "d199863ffc9db867666b46f91ded4dd90670cb9b6704b5177a20902e2f629e3b"
  }
}