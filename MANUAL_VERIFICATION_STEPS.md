# n8n 工作流手动验证和导入步骤

## 🎯 目标
确认 n8n 中的工作流已更新并能正确识别 10/29 的请假人员

---

## 第一步：登录 n8n

1. 打开浏览器访问：
   ```
   https://n8n-production-9f9c.zeabur.app/
   ```

2. 使用你的账号登录

---

## 第二步：检查现有工作流

### A. 查找工作流

1. 在左侧菜单点击 **"Workflows"**
2. 搜索：`出勤統計分析` 或 `attendance`
3. 打开找到的工作流

### B. 检查代码是否已更新

1. 找到 **"解析出缺勤資料"** 节点
2. 点击该节点打开编辑器
3. 查看 `jsCode` 字段的代码

**检查这些关键内容是否存在：**

```javascript
// ✅ 应该看到这行（逗号分隔支持）
const commaParts = messageText.split(/[,，、]/);

// ✅ 应该看到这行（月份推断）
let inferredMonth = null;

// ✅ 应该看到这个函数
function extractSingleDateRange(messageText, messageTimestamp, currentYear, inferredMonth) {

// ✅ 应该看到这个正则模式
{ regex: /^(\d{1,2})\s*[~～\-]\s*(\d{1,2})(?:\s|@|$)/, type: 'day_only' }
```

**结果判断：**
- ✅ **如果都存在** → 工作流已更新，跳到第三步
- ❌ **如果不存在** → 需要导入，继续第二步C

### C. 导入更新的工作流（如果需要）

**方法 1：导入完整工作流（推荐）**

1. 点击左上角菜单 → **"Import from File"**
2. 选择文件：
   ```
   /Users/lonelyhsu/gemini/claude-project/n8n-workflow/attendance-statistics-analysis-SIMPLIFIED.json
   ```
3. 点击 **"Import"**

**重要：重新配置凭证**
4. 配置 **Slack API** 凭证
   - 找到 "取得頻道資訊" 节点
   - 选择或创建 Slack 凭证

5. 配置 **Google Sheets API** 凭证
   - 找到 "更新今日請假" 和 "更新2025年排行榜" 节点
   - 选择或创建 Google Sheets 凭证

6. 点击右上角 **"Save"**

**方法 2：只更新代码（快速）**

1. 打开本地文件 `PARSE_CODE_FIXED_V2.js`
2. 全选并复制所有代码
3. 在 n8n 中，找到 "解析出缺勤資料" 节点
4. 删除节点中的旧代码
5. 粘贴新代码
6. 点击 **"Save"**

---

## 第三步：手动执行测试

### A. 执行工作流

1. 确保工作流已保存
2. 点击右上角的 **"Execute Workflow"** 按钮
3. 等待执行完成

### B. 检查输出

**检查节点 1: "今日請假資料"**

点击该节点查看输出，应该看到：

```json
[
  {
    "date": "2025/10/29",
    "userName": "QA-Lisa",
    "status": "特休",
    "checkInTime": "...",
    "checkOutTime": "...",
    "details": "10/23-11/1 @QA-Lisa 特休"
  },
  {
    "date": "2025/10/29",
    "userName": "RD-Jean",
    "status": "特休",
    "checkInTime": "...",
    "checkOutTime": "...",
    "details": "10/23，27-31 @RD-Jean 特休"
  }
]
```

**预期结果：**
- ✅ 应该看到 **2 条记录**
- ✅ **QA-Lisa** 在 10/29 请假
- ✅ **RD-Jean** 在 10/29 请假

**如果看到：**
```json
[
  {
    "date": "2025/10/29",
    "userName": "無",
    "status": "全員正常上班",
    ...
  }
]
```
❌ 这说明代码还没更新或有其他问题

**检查节点 2: "處理請假資料"**

查看该节点的输出，应该看到包含今天日期和两个请假人员的数据。

**检查节点 3: Console 日志**

在 "解析出缺勤資料" 节点中，查看 console 输出：

```
=== 處理完成 ===
總記錄數：XX
狀態統計：{ "特休": XX, ... }
自動識別的使用者數: XX
```

---

## 第四步：激活工作流

1. 确认测试通过后
2. 点击右上角的开关，确保工作流处于 **"Active"** 状态（绿色）
3. 确认 "每小時執行1" 触发器已启用

---

## 第五步：验证 Slack 消息

等待几分钟后，检查 Slack 频道，应该看到更新的消息：

```
📅 10/29 出勤狀況
👥 共 2 人請假/遠端

🏖️ 特休
• QA-Lisa
• RD-Jean

最後更新: [当前时间]
📊 查看完整統計
```

---

## 🐛 故障排除

### 问题 1: 还是显示"今日無人請假"

**可能原因：**
1. 代码还没更新
2. Slack 频道数据读取有问题
3. 日期格式解析问题

**解决方案：**
1. 重新检查 "解析出缺勤資料" 节点的代码
2. 手动执行 "取得頻道資訊" 节点，查看原始数据
3. 检查 console 日志中的错误信息

### 问题 2: 凭证错误

**症状：** 执行失败，提示 "Invalid credentials"

**解决方案：**
1. 重新配置 Slack API 凭证
2. 重新配置 Google Sheets API 凭证
3. 确保 API Token 有效且权限正确

### 问题 3: 日期格式不匹配

**症状：** 解析出了日期但不匹配今天

**解决方案：**
1. 检查系统时区设置
2. 确认代码中使用的是 'Asia/Taipei' 时区
3. 查看 "今日請假資料" 节点的 console 输出

---

## ✅ 成功标志

如果一切正常，你应该看到：

1. ✅ 工作流执行成功（绿色勾）
2. ✅ "今日請假資料" 节点输出 2 条记录
3. ✅ Slack 消息显示 10/29 和两个请假人员
4. ✅ Google Sheets 正确更新
5. ✅ 工作流处于 Active 状态

---

## 📞 需要帮助？

如果遇到问题：

1. **截图发送：**
   - "解析出缺勤資料" 节点的输出
   - "今日請假資料" 节点的输出
   - 任何错误消息

2. **检查文件：**
   - `test-complete-workflow.js` - 本地测试结果
   - `verify-n8n-workflow.js` - 验证脚本（当 API 可用时）

3. **确认信息：**
   - 当前 n8n 中的工作流名称
   - 工作流是否处于 Active 状态
   - 最后一次成功执行的时间

---

**最后更新**: 2025-10-29
**修复版本**: V3.2
**验证脚本**: verify-n8n-workflow.js
