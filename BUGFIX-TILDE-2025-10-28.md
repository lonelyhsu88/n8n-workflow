# 🐛 Bug Fix: 支援波浪號 (~) 時間格式

**日期：** 2025-10-28
**版本：** v3.1
**問題：** "missing ) after argument list" 語法錯誤
**檔案：** `attendance-statistics-analysis-clean.json`

---

## 🔴 問題描述

### 錯誤訊息
```
missing ) after argument list
SyntaxError
```

### 觸發條件
當 Slack 訊息使用波浪號 (`~`) 作為時間分隔符時：
```
10/27 <@U06PYV3G066> 11:44 ~ 特休
```

### 根本原因
原本的時數計算函數（`calculateLeaveHours`）只支援 `-`（破折號）作為時間分隔符，不支援 `~`（波浪號）。

**原始正則表達式：**
```javascript
const pattern1 = /(\d{1,2})(:00)?-\s*(?=\s|@|$)/;
const pattern2 = /(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/;
```

這些模式只匹配 `-`，不匹配 `~`。

---

## ✅ 修正內容

### 更新的正則表達式

#### 模式 1: 從某時間到下班
**修正前：**
```javascript
const pattern1 = /(\d{1,2})(:00)?-\s*(?=\s|@|$)/;
```

**修正後：**
```javascript
const pattern1Str = '(\\d{1,2}):?(\\d{2})?[\\s]*[\\-~][\\s]*(?=\\s|@|$|特休|病假|事假|年假|出差|遠端)';
const pattern1 = new RegExp(pattern1Str);
```

**改進點：**
1. 支援 `-` 和 `~` 兩種符號：`[\\-~]`
2. 允許前後有空格：`[\\s]*`
3. 更精確的結束條件檢測（包含常見假別關鍵字）
4. 支援完整的分鐘數（`11:44` 而非只有 `11:00`）

#### 模式 2: 明確時間範圍
**修正前：**
```javascript
const pattern2 = /(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})/;
```

**修正後：**
```javascript
const pattern2Str = '(\\d{1,2}):(\\d{2})[\\s]*[\\-~][\\s]*(\\d{1,2}):(\\d{2})';
const pattern2 = new RegExp(pattern2Str);
```

**改進點：**
1. 支援 `-` 和 `~` 兩種符號
2. 允許前後有空格

### 時數計算改進

**修正前：**
```javascript
const hours = Math.max(0, endHour - startHour);
```
只計算整點小時差，忽略分鐘。

**修正後：**
```javascript
const startMin = match1[2] ? parseInt(match1[2]) : 0;
const totalMinutes = (endHour * 60 + endMin) - (startHour * 60 + startMin);
const hours = Math.max(0, totalMinutes / 60);
```
精確計算包含分鐘的時數。

---

## 🧪 測試結果

### 測試案例

| 輸入格式 | 預期結果 | 實際結果 | 狀態 |
|---------|---------|---------|------|
| `11:44 ~ 特休` | 6.27小時 | 6.27小時 | ✅ |
| `14- @Someone 特休` | 4小時 | 4小時 | ✅ |
| `14:00- @Someone 特休` | 4小時 | 4小時 | ✅ |
| `14:00-18:00 @Someone 事假` | 4小時 | 4小時 | ✅ |
| `14:00~18:00 @Someone 事假` | 4小時 | 4小時 | ✅ |
| `15:30~ @Someone 病假` | 2.5小時 | 2.5小時 | ✅ |
| `15:30 ~ @Someone 病假` | 2.5小時 | 2.5小時 | ✅ |
| `13 ~ 特休` | 5小時 | 5小時 | ✅ |

**所有測試通過：8/8** ✅

---

## 📋 支援的時間格式

現在支援以下所有格式：

### 破折號格式 (-)
- `14-` → 14:00 到 18:00 (4小時)
- `14:00-` → 14:00 到 18:00 (4小時)
- `14:00-18:00` → 4小時
- `15:30-18:00` → 2.5小時

### 波浪號格式 (~)
- `14~` → 14:00 到 18:00 (4小時)
- `14:00~` → 14:00 到 18:00 (4小時)
- `14:00~18:00` → 4小時
- `15:30~18:00` → 2.5小時
- `11:44 ~ 特休` → 11:44 到 18:00 (6.27小時)

### 帶空格格式
- `14 - 特休` → 4小時
- `14 ~ 特休` → 4小時
- `14:00 - 18:00` → 4小時
- `14:00 ~ 18:00` → 4小時

### 其他格式（不變）
- `上午` → 3小時
- `下午` → 4小時
- `半天` → 4小時
- 無時間標記 → 8小時（全天）

---

## 🔧 技術細節

### 正則表達式語法說明

#### `[\\-~]` - 匹配 - 或 ~
在 JSON 字串中，反斜線需要雙重轉義：
- JavaScript 中：`[\-~]`
- JSON 中：`[\\-~]`
- 實際匹配：`-` 或 `~`

#### `[\\s]*` - 匹配0或多個空白字符
允許時間符號前後有空格：
- `14~` ✅
- `14 ~` ✅
- `14 ~ ` ✅

#### 為什麼使用 `new RegExp()` 而非字面量？
```javascript
// ❌ 在 JSON 中會有轉義問題
const regex = /pattern/;

// ✅ 在 JSON 中安全
const regexStr = 'pattern';
const regex = new RegExp(regexStr);
```

---

## 📦 影響範圍

### 修改的節點
- **2025年排行榜** 節點（`calculateLeaveHours` 函數）

### 不受影響的功能
- ✅ 日期解析
- ✅ 使用者識別
- ✅ 假別分類
- ✅ 變更檢測
- ✅ Slack 通知
- ✅ Google Sheets 寫入

---

## 🚀 部署步驟

### 1. 備份
已自動建立備份：`attendance-statistics-analysis-clean-v3.1.json`

### 2. 匯入
使用主檔案：`attendance-statistics-analysis-clean.json`

### 3. 測試
執行手動測試，確認波浪號格式正確解析

### 4. 啟用
設為 Active

---

## ⚠️ 注意事項

1. **向下相容**：原有的 `-` 格式仍然完全支援
2. **空格處理**：符號前後的空格會被正確處理
3. **精確度**：分鐘級別的時間現在被精確計算
4. **JSON 安全**：使用字串拼接避免 JSON 轉義問題

---

## 📊 效能影響

- **執行時間**：無明顯變化
- **記憶體使用**：無明顯變化
- **相容性**：100% 向下相容

---

## 🎯 結論

**問題：** ✅ 已完全解決
**測試：** ✅ 8/8 通過
**相容性：** ✅ 保持
**效能：** ✅ 無影響

現在系統可以正確處理所有常見的時間格式，包括破折號 (`-`) 和波浪號 (`~`)。

**版本：** v3.1 (2025-10-28)
**狀態：** ✅ 可安全使用
