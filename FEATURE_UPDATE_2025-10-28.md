# 📋 出勤統計 Workflow 功能更新 v3.0

**更新日期：** 2025-10-28
**檔案名稱：** `attendance-statistics-analysis-clean.json`
**版本：** v3.0 (Hours Calculation + Change Detection)

---

## 🎉 新增功能

### 1. ⏰ **精準時數計算**

#### 支援的格式

| 格式 | 範例 | 計算結果 | 說明 |
|------|------|----------|------|
| **從某時到下班** | `14-` 或 `14:00-` | 4 小時 | 14:00-18:00 |
| **時間範圍** | `14:00-18:00` | 4 小時 | 明確時間範圍 |
| | `15:00-18:00` | 3 小時 | |
| | `09:00-12:00` | 3 小時 | |
| **上午** | `上午請假` 或 `上午` | 3 小時 | 09:00-12:00 |
| **下午** | `下午請假` 或 `下午` | 4 小時 | 14:00-18:00 |
| **半天** | `半天` 或 `半天特休` | 4 小時 | 通用半天 |
| **全天** | 沒有時間標記 | 8 小時 | 預設全天 |

#### 範例

```
訊息：10/27 @Design-Jill Su 上午健檢，下午特休
計算：
  • 上午健檢 = 3 小時 (0.375 天)
  • 下午特休 = 4 小時 (0.5 天)
  • 總計 = 7 小時 (0.875 天)

訊息：14:00-18:00 @Someone 事假
計算：
  • 事假 = 4 小時 (0.5 天)

訊息：15- @Someone 特休
計算：
  • 特休 = 3 小時 (0.375 天) [15:00-18:00]
```

---

### 2. 🔔 **智慧變更檢測**

#### 功能說明
- **只在出勤狀況改變時發送 Slack 通知**
- 避免每小時重複發送相同內容
- 節省通知頻率，提升效率

#### 運作方式

```
第 1 小時 (10:00):
  出勤狀況: A 請假, B 遠端, C 病假
  → 計算 hash: "A:請假|B:遠端|C:病假"
  → ✅ 發送 Slack 通知
  → 儲存 hash 在訊息中

第 2 小時 (11:00):
  出勤狀況: A 請假, B 遠端, C 病假 (相同)
  → 計算 hash: "A:請假|B:遠端|C:病假"
  → 比對上次 hash: 相同
  → ❌ 不發送通知 (避免重複)

第 3 小時 (12:00):
  出勤狀況: A 請假, B 遠端, C 病假, D 特休 (新增 D)
  → 計算 hash: "A:請假|B:遠端|C:病假|D:特休"
  → 比對上次 hash: 不同
  → ✅ 發送 Slack 通知
  → 更新 hash
```

#### Hash 儲存方式
Slack 訊息最後會包含隱藏的 hash 標記：
```
:date: 10/27 出勤狀況
...
最後更新: 15:01
<!-- hash:Design-Jill:特休|QA-Michelle:病假|RD-Alan:遠端 -->
```

---

### 3. 📊 **Google Sheets 新增欄位**

#### 2025排行榜表單新增欄位

| 欄位名稱 | 說明 | 範例 |
|----------|------|------|
| `totalHours` | 總請假時數 | 64.5 小時 |
| `sickLeaveHours` | 病假時數 | 16 小時 |
| `annualLeaveHours` | 特休時數 | 32 小時 |
| `remoteHours` | 遠端工作時數 | 12 小時 |
| `birthdayLeaveHours` | 生日假時數 | 8 小時 |
| *(其他假別時數)* | 依此類推 | |

#### 計算方式

```
員工 A 的請假記錄:
  • 10/1: 全天特休 → 8 小時
  • 10/5: 上午病假 → 3 小時
  • 10/10: 14:00-18:00 事假 → 4 小時
  • 10/15: 下午遠端 → 4 小時

統計結果:
  • totalDays: 2.375 天 (19/8)
  • totalHours: 19 小時
  • annualLeaveHours: 8 小時
  • sickLeaveHours: 3 小時
  • personalLeaveHours: 4 小時
  • remoteHours: 4 小時
```

---

## 🔧 原有功能 (v2.0 修正)

### 1. ✅ 短關鍵字誤判修正
- **問題：** "keyboard" 被誤判為「生日假」（包含 "bd"）
- **修正：** 使用單字邊界匹配
- **結果：** 只有完整的 "bd" 或 "bd假" 才會被識別

### 2. ✅ 日期年份推斷修正
- **問題：** `9/19-9/26` 被解析為 2025 年（未來）
- **修正：** 改進年份推斷邏輯
- **結果：** 正確識別為 2024 年（過去）

### 3. ✅ 系統訊息過濾
- **問題：** "已加入頻道" 被當作出勤記錄
- **修正：** 自動過濾系統訊息
- **結果：** 只處理真實的請假訊息

---

## 📥 匯入方式

### 步驟

1. **備份現有 workflow**（重要！）
2. **登入 n8n**
3. **匯入新版本**
   - 點擊右上角 "..." → "Import from File"
   - 選擇 `attendance-statistics-analysis-clean.json`
4. **更新 Google Sheets 表頭**
   - 在「2025排行榜」表單中加入新欄位：
     - totalHours
     - sickLeaveHours
     - annualLeaveHours
     - remoteHours
     - birthdayLeaveHours
     - (其他假別時數欄位)
5. **測試執行**
6. **啟用 workflow**

---

## 🧪 測試案例

### 時數計算測試

```javascript
// 測試 1: 全天請假
輸入: "10/27 @Someone 特休"
預期: 8 小時 = 1 天

// 測試 2: 上午請假
輸入: "10/27 @Someone 上午病假"
預期: 3 小時 = 0.375 天

// 測試 3: 下午請假
輸入: "10/27 @Someone 下午事假"
預期: 4 小時 = 0.5 天

// 測試 4: 時間範圍
輸入: "14:00-18:00 @Someone 特休"
預期: 4 小時 = 0.5 天

// 測試 5: 從某時到下班
輸入: "15- @Someone 事假"
預期: 3 小時 = 0.375 天 (15:00-18:00)

// 測試 6: 複合請假
輸入: "10/27 @Someone 上午健檢，下午特休"
預期: 7 小時 = 0.875 天 (3 + 4)
```

### 變更檢測測試

```
情境 1: 第一次執行
  → 有 3 人請假
  → ✅ 發送 Slack 通知
  → 儲存 hash

情境 2: 第二次執行（相同）
  → 仍然是 3 人請假，名單相同
  → ❌ 不發送通知

情境 3: 第三次執行（有變更）
  → 有 4 人請假，新增 1 人
  → ✅ 發送 Slack 通知
  → 更新 hash

情境 4: 第四次執行（狀態改變）
  → 仍是 4 人，但 A 的假別從「病假」改為「特休」
  → ✅ 發送 Slack 通知
  → 更新 hash
```

---

## 📊 Google Sheets 範例

### 2025排行榜表單

| 排名 | 姓名 | 總天數 | 總時數 | 病假 | 病假時數 | 特休 | 特休時數 | 遠端 | 遠端時數 |
|------|------|--------|--------|------|----------|------|----------|------|----------|
| 1 | Design-Jill | 8.5 | 68 | 1 | 8 | 5.5 | 44 | 2 | 16 |
| 2 | QA-Michelle | 6.375 | 51 | 2.375 | 19 | 4 | 32 | 0 | 0 |
| 3 | RD-Alan | 5 | 40 | 0 | 0 | 3 | 24 | 2 | 16 |

---

## ⚙️ 技術細節

### calculateLeaveHours 函數

```javascript
function calculateLeaveHours(detailsText) {
  // 模式 1: "14-" → 14:00-18:00 = 4小時
  // 模式 2: "14:00-18:00" → 4小時
  // 模式 3: "上午" → 3小時
  // 模式 4: "下午" → 4小時
  // 模式 5: "半天" → 4小時
  // 預設: 全天 → 8小時

  return {
    hours: 計算的小時數,
    days: hours / 8,
    type: '類型',
    description: '說明'
  };
}
```

### 變更檢測 Hash 計算

```javascript
function calculateAttendanceHash(records) {
  // 將所有記錄排序並序列化
  const sorted = records
    .map(r => `${r.userName}:${r.status}`)
    .sort()
    .join('|');

  return sorted;
  // 範例: "A:特休|B:病假|C:遠端"
}
```

---

## 🚨 注意事項

### 1. **Google Sheets 表頭更新**
   - 必須在 Google Sheets 中手動加入新的時數欄位
   - 否則資料會寫入失敗

### 2. **首次執行**
   - 第一次執行時，因為沒有歷史 hash，一定會發送通知
   - 這是正常行為

### 3. **訊息格式相容性**
   - 舊格式的訊息（沒有時間標記）會預設為全天 8 小時
   - 不影響歷史資料統計

### 4. **時間計算基準**
   - 上班時間：09:00
   - 下班時間：18:00
   - 午休時間：未扣除（如需調整請修改程式碼）

---

## 🔄 升級路徑

### 從 v1.0 升級
1. 備份現有 workflow
2. 匯入新版本
3. 測試功能
4. 啟用

### 從 v2.0 升級
1. 備份現有 workflow
2. 在 Google Sheets 加入時數欄位
3. 匯入新版本
4. 測試時數計算和變更檢測
5. 啟用

---

## 📝 版本歷史

| 版本 | 日期 | 功能 |
|------|------|------|
| v1.0 | 2024 | 初始版本 |
| v2.0 | 2025-10-27 | 修正短關鍵字誤判、日期年份、系統訊息 |
| **v3.0** | **2025-10-28** | **新增時數計算 + 變更檢測** |

---

## 🆘 常見問題

### Q1: 時數計算不準確？
**A:** 檢查訊息格式是否符合支援的模式：
- ✅ `14:00-18:00` (正確)
- ❌ `14~18` (不支援)
- ✅ `14-` (正確)
- ✅ `上午` (正確)

### Q2: 仍然收到重複通知？
**A:** 檢查：
1. If 節點條件是否正確設定
2. Slack 訊息是否包含 hash 標記
3. 「檢查訊息狀態」節點是否正確讀取 hash

### Q3: Google Sheets 寫入失敗？
**A:** 確認：
1. 表頭是否包含所有時數欄位
2. 欄位名稱是否正確（區分大小寫）
3. Google Sheets 認證是否有效

### Q4: 如何調整上下班時間？
**A:** 修改 `calculateLeaveHours` 函數中的 `endHour` 變數：
```javascript
const endHour = 18; // 修改為你的下班時間
```

---

## 📧 支援

如有問題或建議，請檢查：
1. `BUGFIX_SUMMARY.md` - Bug 修正詳情
2. `README-attendance-fix.md` - 使用說明
3. 本文件 - 功能更新說明

---

**準備好升級了嗎？** 立即匯入 `attendance-statistics-analysis-clean.json` 享受新功能！ 🚀
